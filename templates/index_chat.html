<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChangpleAI</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/index_chat.css' %}">
    <!-- 마크다운 변환 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- XSS 공격 방지를 위한 DOMPurify 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
   
</head>
<body>
    <div class="container">
        <div class="header">

            <!-- 창플 메인 로고(좌측)) -->
            {% comment %} <div class="cp-logo-container"> {% endcomment %}
            <div class="cp-logo-container" id="cp-logo" style="cursor: pointer;">

                <svg class="cp-logo">
                    {% comment %} <img src="{% static '../static/img/cp-logo-main.svg' %}" alt="CHAI Logo" /> {% endcomment %}
                    <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 513.51 109.45">
                        <defs>
                        <style>
                            .cls-1 {
                            fill: #617dae;
                            }
                        </style>
                        </defs>
                        <path class="cls-1" d="M49.86,0v77.68c21.2,0,38.38-17.39,38.38-38.84S71.06,0,49.86,0Z"/>
                        <path class="cls-1" d="M11.48,38.84C11.48,17.39,28.67,0,49.86,0H0v100.73h49.86v-23.05c-21.2,0-38.38-17.39-38.38-38.84Z"/>
                        <path class="cls-1" d="M418.07,19.7c-3.19-2.75-7.01-4.12-11.48-4.12h-23.79v42.12h7.53v-14.02h16.26c2.93,0,5.65-.63,8.16-1.89s4.49-2.98,5.93-5.15c1.44-2.17,2.16-4.51,2.16-7.04,0-3.85-1.59-7.15-4.78-9.9h.01ZM411.16,37.45c-2.81,2.19-6.2,3.28-10.15,3.28h-10.67v-22.21h10.67c3.95,0,7.34,1.08,10.15,3.25s4.22,4.78,4.22,7.82-1.41,5.67-4.22,7.85h0Z"/>
                        <polygon class="cls-1" points="438.15 15.58 430.61 15.58 430.61 57.7 469.12 57.7 469.12 54.78 438.15 54.78 438.15 15.58"/>
                        <polygon class="cls-1" points="513.51 18.52 513.51 15.58 475 15.58 475 57.7 513.51 57.7 513.51 54.78 482.54 54.78 482.54 37.48 513.04 37.48 513.04 34.56 482.54 34.56 482.54 18.52 513.51 18.52"/>
                        <path class="cls-1" d="M123.82,28.07c.79-1.43,5.71-10.8,17-8.79.42.08.86.16,1.33.27,1.96.49,6.48,2.37,10.3,6.07l4.53-3.85c-2.28-1.96-4.9-3.49-7.85-4.57-2.95-1.08-6.1-1.62-9.45-1.62-6.74,0-12.5,2.06-17.27,6.17-4.77,4.11-7.15,9.08-7.15,14.89s2.38,10.78,7.15,14.89c4.77,4.11,10.52,6.17,17.27,6.17,3.35,0,6.5-.54,9.45-1.62,2.95-1.08,5.57-2.61,7.85-4.57l-2.44-3.34c-9.36,9.97-19.63,5.71-21.96,4.34-.17-.11-.34-.2-.5-.31-4.35-2.97-7.14-6.44-8.72-11.7-.98-3.61-1.22-5.31-.73-8.46.23-1.47.64-2.75,1.2-3.95v-.02Z"/>
                        <polygon class="cls-1" points="199.14 34.2 171.93 34.2 171.93 15.58 164.4 15.58 164.4 57.7 171.93 57.7 171.93 37.48 199.14 37.48 199.14 57.7 206.68 57.7 206.68 15.58 199.14 15.58 199.14 34.2"/>
                        <path class="cls-1" d="M236.07,15.58l-22.67,42.12h3.59l5.79-10.83,27.85-.29,6.18,11.12h8.3l-22.67-42.12h-6.37,0ZM224.52,43.68l12.38-22.99,12.38,22.99h-24.76Z"/>
                        <path class="cls-1" d="M346.07,36.64v3.06h14.57v11.19l-.84.47c-8.17,5.52-16.04,1.61-18.07.42-.17-.11-.34-.2-.5-.31-1.92-1.31-3.56-2.6-4.94-4.06-1.87-2.12-3.18-4.4-3.92-6.85,0-.03-.02-.05-.03-.07v-.03c-.55-1.97-.86-3.86-.96-5.68,0-.84.08-1.71.24-2.75.23-1.47.64-2.75,1.2-3.95.79-1.43,6.17-10.33,17.46-8.32.42.08.86.16,1.33.27,1.96.49,6.01,1.9,9.84,5.6l4.53-3.85c-1.5-1.29-3.16-2.38-4.95-3.29v-.02c-.13-.07-.26-.12-.39-.18-.24-.12-.48-.23-.72-.34-.43-.19-.86-.37-1.29-.54-.17-.06-.32-.14-.49-.2-.16-.06-.33-.1-.49-.16-.44-.15-.89-.29-1.34-.42-.29-.08-.58-.16-.87-.23-.47-.12-.95-.22-1.43-.31-.26-.05-.51-.1-.77-.14-.58-.09-1.17-.17-1.76-.22-.21-.02-.42-.04-.63-.05-.71-.05-1.43-.09-2.16-.09h0c-.71,0-1.4.03-2.09.08-.28.02-.55.04-.83.07-.34.03-.67.08-1,.12-4.01.52-7.62,1.86-10.84,4.01-.08.05-.17.11-.25.16-.63.43-1.25.9-1.85,1.4-.27.22-.54.45-.8.69-.57.51-1.11,1.04-1.61,1.58-.07.07-.13.15-.2.22-2.5,2.78-4.05,5.89-4.65,9.35-.05.28-.1.57-.14.85-.03.24-.06.48-.08.72-.06.59-.09,1.19-.09,1.8,0,5.82,2.38,10.78,7.15,14.89s10.52,6.17,17.27,6.17h0c.99,0,1.95-.06,2.9-.16.25-.02.49-.06.73-.09.74-.09,1.47-.21,2.19-.36.23-.05.46-.1.68-.15.81-.19,1.62-.42,2.4-.69.11-.04.22-.06.32-.1.07-.03.15-.04.23-.07.82-.3,1.61-.64,2.38-1.01.06-.03.12-.04.17-.07v.03h7.54v-18.38h-22.15Z"/>
                        <polygon class="cls-1" points="308.83 34.2 308.83 37.48 308.83 52.98 278.6 15.59 278.6 15.58 271.06 15.58 271.06 57.7 278.6 57.7 278.6 37.48 278.6 34.2 278.6 20.76 308.46 57.7 312.64 57.7 312.64 57.7 316.36 57.7 316.36 15.58 308.83 15.58 308.83 34.2"/>
                        <path class="cls-1" d="M140.79,80.2c0,2.44-1.01,4.4-3.04,5.91s-4.76,2.26-8.19,2.26h-4.26l-2.87,11.32h2.91v1.02h-9.2v-1.03h2.39l6.36-24.74h-2.96v-1.03h10.42c2.73,0,4.82.54,6.26,1.62,1.45,1.08,2.17,2.63,2.17,4.66h0ZM136.62,78.66c0-1.32-.38-2.27-1.13-2.85-.76-.58-1.99-.87-3.69-.87h-3.04l-3.14,12.38h3.29c2.38,0,4.26-.76,5.65-2.31,1.38-1.54,2.07-3.66,2.07-6.36h0Z"/>
                        <path class="cls-1" d="M151.33,73.55l-6.73,24.12c-.11.34-.16.67-.16,1.01,0,.64.28.96.85.96,1.35,0,2.77-1.56,4.26-4.68l.81.37c-1.7,3.94-3.68,5.91-5.92,5.91-.89,0-1.58-.21-2.07-.62s-.73-1.02-.73-1.82c0-.36.13-1.02.38-1.99l6.06-22.04h-3.2v-.86c1.41,0,2.47-.02,3.2-.06s1.81-.14,3.24-.31h0Z"/>
                        <path class="cls-1" d="M170.59,95.21c-1.43,4.02-3.36,6.03-5.8,6.03-1.65,0-2.47-.94-2.47-2.83-1.27,1.89-2.91,2.83-4.91,2.83-1.46,0-2.66-.53-3.59-1.59s-1.4-2.47-1.4-4.23c0-2.45,1.03-4.84,3.08-7.17,2.05-2.34,4.13-3.5,6.24-3.5,1.95,0,3.13.89,3.57,2.67l.69-2.3h2.84l-3.12,10.9c-.43,1.54-.65,2.5-.65,2.88,0,.58.24.86.73.86,1.4,0,2.72-1.61,3.93-4.84l.85.29h0ZM164.51,88.45c0-1.89-.84-2.84-2.51-2.84-1.46,0-2.81,1.11-4.05,3.33-.81,1.48-1.43,2.97-1.86,4.48-.43,1.51-.65,2.78-.65,3.83,0,.96.22,1.69.65,2.2.43.51,1.05.76,1.86.76,1.76,0,3.23-1.19,4.42-3.58.46-.93,1-2.56,1.62-4.9.35-1.34.53-2.44.53-3.29h0Z"/>
                        <path class="cls-1" d="M181.78,85.98h-3.27l-3.3,12.02c-.13.34-.2.63-.2.88,0,.51.31.76.94.76,1.25,0,2.71-1.68,4.37-5.05l.82.37c-1.86,4.18-3.93,6.28-6.2,6.28-.81,0-1.47-.21-1.97-.64s-.75-.99-.75-1.68c0-.44.11-1.06.31-1.87l3.12-11.08h-2.66v-.86h2.94l1.17-4.35h2.92l-1.18,4.35h2.95v.86h0Z"/>
                        <path class="cls-1" d="M199.82,75.93c0,1.15-.49,1.72-1.46,1.72-1.14,0-1.7-.49-1.7-1.48,0-.33.04-.57.12-.74.08-.16.16-.31.24-.45,0-.33-.24-.49-.73-.49-2.11,0-4.01,3.54-5.72,10.63h3.61v.94h-3.85l-1.86,7.1c-1.54,5.85-2.97,9.93-4.3,12.23-1.57,2.71-3.54,4.06-5.92,4.06-.87,0-1.57-.22-2.11-.66s-.81-.98-.81-1.64c0-1.12.54-1.68,1.62-1.68.97,0,1.46.46,1.46,1.39,0,.27-.06.53-.18.78s-.18.41-.18.49c0,.27.26.41.77.41,1.32,0,2.46-.93,3.41-2.79.38-.74.8-2.11,1.28-4.12.47-2.01.98-4.19,1.52-6.54.54-2.35,1.3-5.36,2.27-9.03h-3.24v-.94h3.53c2.08-7.71,5.15-11.57,9.2-11.57.95,0,1.69.22,2.23.66s.81,1.01.81,1.72h-.01Z"/>
                        <path class="cls-1" d="M209.59,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.12-.57-4.24-1.71-1.12-1.14-1.68-2.53-1.68-4.18,0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM206.34,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.68-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M224.95,86.19c0,1.15-.55,1.72-1.65,1.72-.48,0-.92-.2-1.31-.59-.39-.4-.63-.6-.71-.6-.65,0-1.41.68-2.3,2.05-1.02,1.59-1.82,3.56-2.38,5.92l-1.45,6.03h-2.92l3.65-14.74h-2.84v-.86c.76,0,1.61,0,2.53-.02.93-.02,2.1-.15,3.51-.42l-1.16,4.34c.97-1.51,1.85-2.61,2.65-3.31.79-.7,1.62-1.05,2.49-1.05.57,0,1.02.15,1.37.45.35.3.53.66.53,1.07h0Z"/>
                        <path class="cls-1" d="M252.52,95.38c-1.3,3.91-3.26,5.87-5.88,5.87-1.59,0-2.39-.75-2.39-2.26,0-.49.14-1.22.41-2.17l2.28-7.95c.15-.69.22-1.22.22-1.6,0-.85-.53-1.27-1.58-1.27s-2.2.59-3.37,1.78-1.97,2.62-2.4,4.28l-2.28,8.66h-2.94l3-11.4c.05-.25.13-.55.22-.91s.14-.67.14-.91c0-1-.55-1.5-1.66-1.5s-2.16.59-3.3,1.76c-1.15,1.17-1.92,2.53-2.33,4.07l-2.38,8.91h-2.93l3.8-14.73h-2.99v-.86c2.16,0,4.24-.12,6.27-.37l-1.01,3.77c1.83-2.52,3.79-3.77,5.86-3.77,2.24,0,3.36,1.03,3.36,3.08v.74c1.7-2.54,3.66-3.81,5.88-3.81,1.11,0,1.96.25,2.55.74s.89,1.18.89,2.05c0,.55-.07,1.09-.2,1.64l-2.55,9.07c-.11.38-.16.68-.16.9,0,.41.24.62.73.62,1.32,0,2.66-1.57,4.01-4.72l.73.33v-.04Z"/>
                        <path class="cls-1" d="M287.87,73.92l-1.66,6.89h-1.01c.11-.61.17-1.04.18-1.3.01-.26.02-.47.02-.64,0-1.76-.51-2.89-1.54-3.39-.76-.36-2.46-.54-5.11-.54h-2.92l-2.84,11.2.77.04c3.06,0,5.03-1.4,5.92-4.19h1.1l-2.64,10.38h-1.05l.16-1.85c0-1.2-.31-2.04-.94-2.5-.62-.46-1.68-.7-3.18-.7h-.45l-3.14,12.35h3.04v1.03h-9.24v-1.03h2.35l6.28-24.74h-2.92v-1.03h18.81v.02Z"/>
                        <path class="cls-1" d="M297.47,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.12-.57-4.24-1.71s-1.68-2.53-1.68-4.18c0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM294.23,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.67-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M312.84,86.19c0,1.15-.55,1.72-1.65,1.72-.48,0-.92-.2-1.31-.59-.39-.4-.63-.6-.71-.6-.65,0-1.41.68-2.3,2.05-1.02,1.59-1.82,3.56-2.38,5.92l-1.45,6.03h-2.92l3.65-14.74h-2.84v-.86c.76,0,1.61,0,2.53-.02.93-.02,2.1-.15,3.51-.42l-1.16,4.34c.97-1.51,1.85-2.61,2.65-3.31.79-.7,1.62-1.05,2.49-1.05.57,0,1.02.15,1.37.45.35.3.53.66.53,1.07h0Z"/>
                        <path class="cls-1" d="M346.89,73.92l-1.66,6.89h-1.01c.11-.61.17-1.04.18-1.3.01-.26.02-.47.02-.64,0-1.76-.51-2.89-1.54-3.39-.76-.36-2.46-.54-5.11-.54h-2.92l-2.84,11.2.77.04c3.06,0,5.03-1.4,5.92-4.19h1.1l-2.64,10.38h-1.05l.16-1.85c0-1.2-.31-2.04-.94-2.5-.62-.46-1.68-.7-3.18-.7h-.45l-3.14,12.35h3.04v1.03h-9.24v-1.03h2.35l6.28-24.74h-2.92v-1.03h18.81v.02Z"/>
                        <path class="cls-1" d="M356.5,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.11-.57-4.24-1.71-1.12-1.14-1.68-2.53-1.68-4.18,0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM353.26,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.68-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M377.42,95.46c-.6,1.86-1.39,3.29-2.38,4.29s-2.06,1.5-3.2,1.5c-.87,0-1.56-.21-2.08-.62s-.77-.94-.77-1.6l.12-1.52c-1.94,2.49-3.93,3.73-5.98,3.73-1.1,0-1.96-.24-2.56-.72-.61-.48-.91-1.15-.91-2,0-.3.08-.76.25-1.36l2.79-11.16h-3.03v-.87c2.38,0,4.46-.12,6.24-.37l-3.28,12.76-.16,1c0,.95.53,1.42,1.58,1.42,1.35,0,2.6-.68,3.74-2.04,1.14-1.36,2.04-3.32,2.72-5.87l1.83-6.89h2.89l-3.24,12.47c-.14.49-.2.9-.2,1.23,0,.63.31.94.93.94,1.35,0,2.66-1.55,3.93-4.64l.77.33h0Z"/>
                        <path class="cls-1" d="M397.61,95.34c-.73,1.98-1.55,3.46-2.48,4.44-.93.98-2.04,1.47-3.33,1.47-.78,0-1.41-.2-1.88-.6s-.71-.94-.71-1.6c0-.47.07-1.05.2-1.75l2.41-8.4.26-1.33c0-1.05-.57-1.57-1.7-1.57s-2.3.62-3.5,1.86-2.06,2.82-2.57,4.75l-2.14,8.12h-2.97l3.81-14.73h-3v-.86c1.89,0,3.13-.02,3.73-.06.59-.04,1.45-.14,2.55-.31l-1.01,3.81c1.76-2.54,3.76-3.81,6-3.81,1.13,0,2.04.26,2.72.77.68.51,1.01,1.22,1.01,2.11,0,.22-.03.48-.08.79s-.12.63-.2.96l-2.59,9.03-.12.59c0,.51.27.76.81.76,1.38,0,2.72-1.59,4.01-4.76l.77.33h0Z"/>
                        <path class="cls-1" d="M418.56,73.55l-6.73,24.25c-.14.42-.2.73-.2.92,0,.67.34,1.01,1.01,1.01s1.34-.43,2.07-1.28c.73-.86,1.39-2.11,1.99-3.76l.93.37c-1.51,4.13-3.45,6.19-5.8,6.19-1.73,0-2.59-.86-2.59-2.58v-.21c-1.35,1.86-2.99,2.79-4.91,2.79-1.43,0-2.66-.55-3.67-1.66-1.01-1.1-1.52-2.49-1.52-4.15,0-2.35.96-4.68,2.89-7,2.03-2.46,4.22-3.68,6.55-3.68,1.71,0,2.86.66,3.46,1.98l3.27-11.94h-3.28v-.87c2.32,0,4.5-.12,6.53-.37h0ZM411.31,88.23c0-1.77-.85-2.66-2.55-2.66s-2.99,1.05-4.09,3.15c-.19.38-.43.94-.71,1.68s-.53,1.49-.75,2.25c-.62,2.18-.93,3.71-.93,4.58,0,1.99.86,2.99,2.59,2.99,2,0,3.57-1.46,4.7-4.38.57-1.42,1-2.88,1.3-4.4.3-1.51.45-2.58.45-3.21h-.01Z"/>
                    </svg>
                </svg>
            </div>  


            <div class="right-menu">
                <!-- 마이페이지 (로그인 후) -->
                {% comment %} <div class="mypage-btn">
                    <svg class="mypage-icon" width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evened" clip-rule="evenodd" d="M8.24279 6.8065C9.09527 6.8065 9.91284 6.46786 10.5156 5.86506C11.1184 5.26226 11.4571 4.4447 11.4571 3.59222C11.4571 2.73973 11.1184 1.92217 10.5156 1.31937C9.91284 0.716577 9.09527 0.37793 8.24279 0.37793C7.39031 0.37793 6.57274 0.716577 5.96994 1.31937C5.36715 1.92217 5.0285 2.73973 5.0285 3.59222C5.0285 4.4447 5.36715 5.26226 5.96994 5.86506C6.57274 6.46786 7.39031 6.8065 8.24279 6.8065ZM0.742787 16.4494C0.742787 15.4644 0.936781 14.4892 1.31369 13.5792C1.6906 12.6693 2.24305 11.8425 2.93949 11.1461C3.63593 10.4496 4.46272 9.89717 5.37266 9.52026C6.2826 9.14335 7.25787 8.94936 8.24279 8.94936C9.2277 8.94936 10.203 9.14335 11.1129 9.52026C12.0229 9.89717 12.8496 10.4496 13.5461 11.1461C14.2425 11.8425 14.795 12.6693 15.1719 13.5792C15.5488 14.4892 15.7428 15.4644 15.7428 16.4494H0.742787Z" fill="#889DC4"/>
                    </svg>
                    <div class="mypage-btn-text">마이 페이지</div>  
                </div> {% endcomment %}


                <div class="mypage-btn" onclick="location.href='{% url 'profile' %}'">
                    <svg class="mypage-icon" width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.24279 6.8065C9.09527 6.8065 9.91284 6.46786 10.5156 5.86506C11.1184 5.26226 11.4571 4.4447 11.4571 3.59222C11.4571 2.73973 11.1184 1.92217 10.5156 1.31937C9.91284 0.716577 9.09527 0.37793 8.24279 0.37793C7.39031 0.37793 6.57274 0.716577 5.96994 1.31937C5.36715 1.92217 5.0285 2.73973 5.0285 3.59222C5.0285 4.4447 5.36715 5.26226 5.96994 5.86506C6.57274 6.46786 7.39031 6.8065 8.24279 6.8065ZM0.742787 16.4494C0.742787 15.4644 0.936781 14.4892 1.31369 13.5792C1.6906 12.6693 2.24305 11.8425 2.93949 11.1461C3.63593 10.4496 4.46272 9.89717 5.37266 9.52026C6.2826 9.14335 7.25787 8.94936 8.24279 8.94936C9.2277 8.94936 10.203 9.14335 11.1129 9.52026C12.0229 9.89717 12.8496 10.4496 13.5461 11.1461C14.2425 11.8425 14.795 12.6693 15.1719 13.5792C15.5488 14.4892 15.7428 15.4644 15.7428 16.4494H0.742787Z" fill="#889DC4"/>
                    </svg>
                    <div class="mypage-btn-text">마이 페이지</div>  
                </div>
        

                <!-- 유료플랜 결제 -->
                <div class="payment-btn">
                    <svg class="payment-icon" width="23" height="22" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.7339 0.200195L13.2023 7.40581L18.9589 2.82986L15.452 9.29355L22.8032 9.48839L15.962 12.1857L21.4681 17.0602L14.4936 14.7291L15.5782 22.0023L11.7339 15.7335L7.88962 22.0023L8.97425 14.7291L1.9998 17.0602L7.50585 12.1857L0.664688 9.48839L8.01582 9.29355L4.50899 2.82986L10.2655 7.40581L11.7339 0.200195Z" fill="#889DC4"/>
                        </svg>
                    <div class="payment-btn-text">유료플랜 결제</div>
                </div>
            </div>


        </div>

        <div class="main-content-prompt">
            <div class="prompt-container">
                <div class="prompt-wrapper">

                </div>
            </div>

            <div class="input-container-prompt">
                <input type="text" class="input-box-unlocked" placeholder="창업의 모든 것을 물어보세요" />
                
                <!-- 창플 아이콘 (input 미입력) -->
                <div class="changple-btn">
                    <svg class="changple-icon" width="30" height="34" viewBox="0 0 30 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.0019 26.0245C18.6708 26.0245 20.3233 25.6958 21.8651 25.0572C23.4069 24.4186 24.8078 23.4825 25.9879 22.3024C27.1679 21.1224 28.104 19.7215 28.7427 18.1796C29.3813 16.6378 29.71 14.9853 29.71 13.3165C29.71 11.6476 29.3813 9.99512 28.7427 8.4533C28.104 6.91149 27.1679 5.51056 25.9879 4.33051C24.8078 3.15045 23.4069 2.21438 21.8651 1.57574C20.3233 0.937102 18.6708 0.608398 17.0019 0.608398L17.0019 13.3165L17.0019 26.0245Z" fill="#90A4C8"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17 0.608398H0.290001V33.8249H17V26.0245C17 26.0245 17 26.0245 17 26.0245L17 13.3165V0.608402C17 0.608402 17 0.608398 17 0.608398ZM17 0.608398V26.0245C15.3312 26.0245 13.6787 25.6958 12.1369 25.0572C10.5951 24.4186 9.19414 23.4825 8.01408 22.3024C6.83403 21.1224 5.89796 19.7215 5.25932 18.1796C4.62068 16.6378 4.29197 14.9853 4.29197 13.3165C4.29197 11.6476 4.62068 9.99512 5.25932 8.45331C5.89796 6.91149 6.83403 5.51056 8.01408 4.33051C9.19413 3.15046 10.5951 2.21439 12.1369 1.57575C13.6787 0.937108 15.3312 0.608401 17 0.608398Z" fill="#90A4C8"/>
                    </svg>
                </div>

                <!--send btn 글자 입력시-->
                <div class="send-btn">
                    <svg class="send-icon" width="23" height="26" viewBox="0 0 23 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1.03659 12.7966C0.741862 12.5018 0.576294 12.102 0.576294 11.6852C0.576294 11.2683 0.741862 10.8685 1.03659 10.5737L10.4693 1.14096C10.7641 0.846232 11.1639 0.680664 11.5808 0.680664C11.9977 0.680664 12.3975 0.846232 12.6923 1.14096L22.125 10.5737C22.4114 10.8702 22.5698 11.2673 22.5662 11.6795C22.5627 12.0917 22.3973 12.486 22.1058 12.7775C21.8143 13.069 21.42 13.2343 21.0078 13.2379C20.5956 13.2415 20.1985 13.083 19.902 12.7966L13.1529 6.04754V24.2621C13.1529 24.679 12.9873 25.0789 12.6924 25.3738C12.3976 25.6686 11.9977 25.8342 11.5808 25.8342C11.1638 25.8342 10.764 25.6686 10.4691 25.3738C10.1743 25.0789 10.0087 24.679 10.0087 24.2621V6.04754L3.25956 12.7966C2.96475 13.0914 2.56495 13.2569 2.14808 13.2569C1.73121 13.2569 1.3314 13.0914 1.03659 12.7966Z" fill="#617DAE"/>
                    </svg>
                </div>         
            </div>
        </div>

        <div class="help-btn">?</div>

        <footer>
            <div class="company-info">(주)창플 | 283-88-00641 | 한범구 | 서울 송파구 송파대로 167 (문정동)테라타워 B동, 707호 | 02-2054-3956 | tiger9@changple.com</div>
            <div class="copyright">@Copyright @ ChangpleTeamBusiness Inc. All Rights Reserved.</div>
            <div class="privacy-policy">개인정보처리방침</div>
        </footer>
    </div>
    {% load static %}
    <script src="{% static 'js/index.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 대화 기록을 저장할 배열 추가
            let chatHistory = [];
            
            // 무료 사용 횟수 초기화 (총 10회)
            let remainingFreeCount = 10;
            
            // Get the initial message from Django context
            const initialMessage = "{{ initial_message|escapejs }}";
            
            if (initialMessage) {
                // Process the initial message if available
                callChatAPI(initialMessage);
            }
            
            // 입력 필드와 전송 버튼 가져오기
            const inputBox = document.querySelector('.input-box-unlocked');
            const sendBtn = document.querySelector('.send-btn');
            const changpleBtn = document.querySelector('.changple-btn');
            
            // Show/hide the appropriate button based on input content
            inputBox.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    changpleBtn.style.display = 'none';
                    sendBtn.style.display = 'flex';
                } else {
                    changpleBtn.style.display = 'flex';
                    sendBtn.style.display = 'none';
                }
            });
            
            // Trigger input event to set initial state
            inputBox.dispatchEvent(new Event('input'));
            
            // 전송 버튼 클릭 이벤트
            sendBtn.addEventListener('click', function() {
                const message = inputBox.value.trim();
                if (message) {
                    callChatAPI(message);
                    inputBox.value = ''; // 입력 필드 비우기
                    inputBox.dispatchEvent(new Event('input')); // Update button display
                }
            });
            
            // 엔터키 이벤트
            inputBox.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    const message = this.value.trim();
                    if (message) {
                        callChatAPI(message);
                        this.value = ''; // 입력 필드 비우기
                        this.dispatchEvent(new Event('input')); // Update button display
                    }
                }
            });
            
            // Chat API 호출 함수
            function callChatAPI(query) {
                // Add user message to chat
                addMessageToChat('user', query);
                
                // 로딩 메시지 추가
                const loadingId = addLoadingMessage();
                
                fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // CSRF 토큰 가져오기
                    },
                    body: JSON.stringify({
                        query: query,
                        session_nonce: "{{ chat_session.session_nonce }}",
                        history: chatHistory // 대화 기록 전송
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 로딩 메시지 제거
                    removeLoadingMessage(loadingId);
                    
                    // Check for errors first
                    if (data.error) {
                        addMessageToChat('assistant', `오류가 발생했습니다: ${data.error}`);
                        addFreeUseCount(remainingFreeCount);
                        return;
                    }
                    
                    // API 응답 처리
                    if (data.response) {
                        // 응답을 대화 영역에 추가
                        addMessageToChat('assistant', data.response);
                        
                        // 대화 기록 업데이트 - Format to match what chain.py expects
                        if (chatHistory.length === 0) {
                            // First message - create initial entry
                            chatHistory.push({
                                "human": query,
                                "ai": data.response
                            });
                        } else {
                            // Follow-up - ensure correct format for rephrasing
                            chatHistory.push({
                                "human": query,
                                "ai": data.response
                            });
                        }
                        
                        // If server sent back history, use that instead
                        if (data.history && data.history.length > 0) {
                            chatHistory = data.history;
                        }
                        
                        // 검색 결과로 카드 업데이트
                        if (data.search_results && data.search_results.length > 0) {
                            console.log("Received search results:", data.search_results);
                            updateSearchCards(data.search_results);
                        }
                            
                        // 무료 사용 횟수 감소 및 표시
                        if (remainingFreeCount > 0) {
                            remainingFreeCount--;
                        }
                        addFreeUseCount(remainingFreeCount);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 로딩 메시지 제거
                    removeLoadingMessage(loadingId);
                    // 오류 메시지 추가
                    addMessageToChat('assistant', '오류가 발생했습니다. 다시 시도해주세요.');
                    addFreeUseCount(remainingFreeCount); // 에러 발생 시에도 카운트 표시
                });
            }
            
            // 무료 사용 카운트 추가 함수
            function addFreeUseCount(count) {
                const promptContainer = document.querySelector('.prompt-wrapper');
                
                // 고유 ID 생성
                const counterId = 'free-use-count-' + Date.now();
                
                const freeUseCountHTML = `
                    <div id="${counterId}" class="free-use-count-container">
                        <div class="free-use-count">
                            <p>무료 사용(${count}/10)</p>
                        </div>  
                         <div class="pay-use-btn">
                            <p>1:1 문의하기</p>
                        </div> 
                    </div>
                `;
                
                promptContainer.insertAdjacentHTML('beforeend', freeUseCountHTML);
            }
            
            //--- 유료 사용 유도 버튼 ---



            // 대화 메시지를 화면에 추가하는 함수
            function addMessageToChat(role, content) {
                const promptContainer = document.querySelector('.prompt-wrapper');
                
                if (role === 'user') {
                    // 고유 ID 생성
                    const messageId = 'user-message-' + Date.now();
                    
                    // 사용자 메시지 추가
                    const userMessageHTML = `
                        <div id="${messageId}" class="prompt-answer-block">
                            <div class="prompt-text-area">
                                <p>${content}</p>
                            </div>
                        </div>
                    `;
                    promptContainer.insertAdjacentHTML('beforeend', userMessageHTML);
                    
                    // 새 메시지로 스크롤 (smoothly)
                    document.getElementById(messageId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (role === 'assistant') {
                    // 챗봇 응답에 고유 ID 부여
                    const botMessageId = 'bot-message-' + Date.now();
                    
                    // 마크다운 렌더링 적용
                    const renderedContent = DOMPurify.sanitize(marked.parse(content));
                    
                    const botMessageHTML = `
                        <br>
                        <div id="${botMessageId}" class="prompt-p">${renderedContent}</div>
                    `;
                    promptContainer.insertAdjacentHTML('beforeend', botMessageHTML);
                    
                    // 새 메시지로 스크롤
                    document.getElementById(botMessageId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
            
            // 로딩 메시지 추가
            function addLoadingMessage() {
                const loadingId = 'loading-' + Date.now();
                const promptContainer = document.querySelector('.prompt-wrapper');
                const loadingHTML = `
                    <div id="${loadingId}" class="prompt-p">생성중...</div>
                `;
                promptContainer.insertAdjacentHTML('beforeend', loadingHTML);

                // 새 메시지로 스크롤 (smoothly)
                document.getElementById(loadingId).scrollIntoView({ behavior: 'smooth', block: 'center' });
                return loadingId;
            }
            
            // 로딩 메시지 제거
            function removeLoadingMessage(loadingId) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
            
            // 검색 결과 카드 업데이트
            function updateSearchCards(searchResults) {
                if (searchResults && searchResults.length > 0) {
                    // 새로운 검색 결과 컨테이너 생성
                    const promptContainer = document.querySelector('.prompt-wrapper');
                    
                    // 새 검색 결과 컨테이너 생성
                    const newLinksContainer = document.createElement('div');
                    newLinksContainer.className = 'prompt-links-container';
                    
                    // 최대 3개까지만 표시
                    const maxCardsToShow = Math.min(searchResults.length, 3);
                    
                    for (let i = 0; i < maxCardsToShow; i++) {
                        const result = searchResults[i];
                        const title = result.metadata && result.metadata.title || '제목 없음';
                        // 타이틀 25자로 제한
                        const shortTitle = title.length > 25
                            ? title.substring(0, 25) + '...' 
                            : title;
                        const content = result.content || '';
                        
                        // content 첫 15자만 표시 (있을 경우)
                        const shortContent = content.length > 15 
                            ? content.substring(0, 15) + '...' 
                            : content;
                        
                        const url = result.metadata && result.metadata.url || 'https://cafe.naver.com';
                        
                        // 카드 요소 생성
                        const cardHTML = `
                            <div class="prompt-links-cards">
                                <a href="${url}" target="_blank" class="link-card">
                                    <div class="card-content">
                                        <div class="card-title">${shortTitle}</div>
                                        <div class="card-description">${shortContent}</div>
                                    </div>
                                </a>
                            </div>
                        `;
                        
                        // 새 컨테이너에 카드 추가
                        newLinksContainer.innerHTML += cardHTML;
                    }
                    
                    // 각 대화 후 새 컨테이너를 추가
                    promptContainer.appendChild(newLinksContainer);
                }
            }
            
            // CSRF 토큰 가져오기 위한 함수
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });

         // cp-logo-container 클릭 이벤트 리스너 추가
         const cpLogoContainer = document.getElementById('cp-logo');
         cpLogoContainer.addEventListener('click', function() {
             // 클릭 시 이동할 URL
             location.href = 'http://localhost:8000/';
         });
    
    </script>
</body>
</html>