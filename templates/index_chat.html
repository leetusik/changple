{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChanpleAI - Chat</title>
    
    <link rel="icon" href="{% static 'img/favicon.svg' %}" type="image/x-icon">

    <link rel="stylesheet" href="{% static 'css/index_chat.css' %}">
    <!-- 마크다운 변환 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- XSS 공격 방지를 위한 DOMPurify 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        /* Mobile message styling */
        .mobile-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 18px;
            line-height: 1.6;
            color: #617DAE;
        }
        
        /* Media query for mobile devices */
        @media screen and (max-width: 768px) {
            .container {
                display: none !important;
            }
            .mobile-message {
                display: flex;
            }
        }


    </style>
</head>
<body>
    <!-- Mobile message -->
    <div class="mobile-message">
        <p>모바일 접속을 지원하지 않습니다.</p>
        <p>PC로 접속하여 사용해주세요.</p>
    </div>

    <div class="container">
        <div class="header">

            <!-- 창플 메인 로고(좌측)) -->
            <div class="cp-logo-container" id="cp-logo" style="cursor: pointer;">

                <svg class="cp-logo">
                    
                    <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 513.51 109.45">
                        <defs>
                        <style>
                            .cls-1 {
                            fill: #617dae;
                            }
                        </style>
                        </defs>
                        <path class="cls-1" d="M49.86,0v77.68c21.2,0,38.38-17.39,38.38-38.84S71.06,0,49.86,0Z"/>
                        <path class="cls-1" d="M11.48,38.84C11.48,17.39,28.67,0,49.86,0H0v100.73h49.86v-23.05c-21.2,0-38.38-17.39-38.38-38.84Z"/>
                        <path class="cls-1" d="M418.07,19.7c-3.19-2.75-7.01-4.12-11.48-4.12h-23.79v42.12h7.53v-14.02h16.26c2.93,0,5.65-.63,8.16-1.89s4.49-2.98,5.93-5.15c1.44-2.17,2.16-4.51,2.16-7.04,0-3.85-1.59-7.15-4.78-9.9h.01ZM411.16,37.45c-2.81,2.19-6.2,3.28-10.15,3.28h-10.67v-22.21h10.67c3.95,0,7.34,1.08,10.15,3.25s4.22,4.78,4.22,7.82-1.41,5.67-4.22,7.85h0Z"/>
                        <polygon class="cls-1" points="438.15 15.58 430.61 15.58 430.61 57.7 469.12 57.7 469.12 54.78 438.15 54.78 438.15 15.58"/>
                        <polygon class="cls-1" points="513.51 18.52 513.51 15.58 475 15.58 475 57.7 513.51 57.7 513.51 54.78 482.54 54.78 482.54 37.48 513.04 37.48 513.04 34.56 482.54 34.56 482.54 18.52 513.51 18.52"/>
                        <path class="cls-1" d="M123.82,28.07c.79-1.43,5.71-10.8,17-8.79.42.08.86.16,1.33.27,1.96.49,6.48,2.37,10.3,6.07l4.53-3.85c-2.28-1.96-4.9-3.49-7.85-4.57-2.95-1.08-6.1-1.62-9.45-1.62-6.74,0-12.5,2.06-17.27,6.17-4.77,4.11-7.15,9.08-7.15,14.89s2.38,10.78,7.15,14.89c4.77,4.11,10.52,6.17,17.27,6.17,3.35,0,6.5-.54,9.45-1.62,2.95-1.08,5.57-2.61,7.85-4.57l-2.44-3.34c-9.36,9.97-19.63,5.71-21.96,4.34-.17-.11-.34-.2-.5-.31-4.35-2.97-7.14-6.44-8.72-11.7-.98-3.61-1.22-5.31-.73-8.46.23-1.47.64-2.75,1.2-3.95v-.02Z"/>
                        <polygon class="cls-1" points="199.14 34.2 171.93 34.2 171.93 15.58 164.4 15.58 164.4 57.7 171.93 57.7 171.93 37.48 199.14 37.48 199.14 57.7 206.68 57.7 206.68 15.58 199.14 15.58 199.14 34.2"/>
                        <path class="cls-1" d="M236.07,15.58l-22.67,42.12h3.59l5.79-10.83,27.85-.29,6.18,11.12h8.3l-22.67-42.12h-6.37,0ZM224.52,43.68l12.38-22.99,12.38,22.99h-24.76Z"/>
                        <path class="cls-1" d="M346.07,36.64v3.06h14.57v11.19l-.84.47c-8.17,5.52-16.04,1.61-18.07.42-.17-.11-.34-.2-.5-.31-1.92-1.31-3.56-2.6-4.94-4.06-1.87-2.12-3.18-4.4-3.92-6.85,0-.03-.02-.05-.03-.07v-.03c-.55-1.97-.86-3.86-.96-5.68,0-.84.08-1.71.24-2.75.23-1.47.64-2.75,1.2-3.95.79-1.43,6.17-10.33,17.46-8.32.42.08.86.16,1.33.27,1.96.49,6.01,1.9,9.84,5.6l4.53-3.85c-1.5-1.29-3.16-2.38-4.95-3.29v-.02c-.13-.07-.26-.12-.39-.18-.24-.12-.48-.23-.72-.34-.43-.19-.86-.37-1.29-.54-.17-.06-.32-.14-.49-.2-.16-.06-.33-.1-.49-.16-.44-.15-.89-.29-1.34-.42-.29-.08-.58-.16-.87-.23-.47-.12-.95-.22-1.43-.31-.26-.05-.51-.1-.77-.14-.58-.09-1.17-.17-1.76-.22-.21-.02-.42-.04-.63-.05-.71-.05-1.43-.09-2.16-.09h0c-.71,0-1.4.03-2.09.08-.28.02-.55.04-.83.07-.34.03-.67.08-1,.12-4.01.52-7.62,1.86-10.84,4.01-.08.05-.17.11-.25.16-.63.43-1.25.9-1.85,1.4-.27.22-.54.45-.8.69-.57.51-1.11,1.04-1.61,1.58-.07.07-.13.15-.2.22-2.5,2.78-4.05,5.89-4.65,9.35-.05.28-.1.57-.14.85-.03.24-.06.48-.08.72-.06.59-.09,1.19-.09,1.8,0,5.82,2.38,10.78,7.15,14.89s10.52,6.17,17.27,6.17h0c.99,0,1.95-.06,2.9-.16.25-.02.49-.06.73-.09.74-.09,1.47-.21,2.19-.36.23-.05.46-.1.68-.15.81-.19,1.62-.42,2.4-.69.11-.04.22-.06.32-.1.07-.03.15-.04.23-.07.82-.3,1.61-.64,2.38-1.01.06-.03.12-.04.17-.07v.03h7.54v-18.38h-22.15Z"/>
                        <polygon class="cls-1" points="308.83 34.2 308.83 37.48 308.83 52.98 278.6 15.59 278.6 15.58 271.06 15.58 271.06 57.7 278.6 57.7 278.6 37.48 278.6 34.2 278.6 20.76 308.46 57.7 312.64 57.7 312.64 57.7 316.36 57.7 316.36 15.58 308.83 15.58 308.83 34.2"/>
                        <path class="cls-1" d="M140.79,80.2c0,2.44-1.01,4.4-3.04,5.91s-4.76,2.26-8.19,2.26h-4.26l-2.87,11.32h2.91v1.02h-9.2v-1.03h2.39l6.36-24.74h-2.96v-1.03h10.42c2.73,0,4.82.54,6.26,1.62,1.45,1.08,2.17,2.63,2.17,4.66h0ZM136.62,78.66c0-1.32-.38-2.27-1.13-2.85-.76-.58-1.99-.87-3.69-.87h-3.04l-3.14,12.38h3.29c2.38,0,4.26-.76,5.65-2.31,1.38-1.54,2.07-3.66,2.07-6.36h0Z"/>
                        <path class="cls-1" d="M151.33,73.55l-6.73,24.12c-.11.34-.16.67-.16,1.01,0,.64.28.96.85.96,1.35,0,2.77-1.56,4.26-4.68l.81.37c-1.7,3.94-3.68,5.91-5.92,5.91-.89,0-1.58-.21-2.07-.62s-.73-1.02-.73-1.82c0-.36.13-1.02.38-1.99l6.06-22.04h-3.2v-.86c1.41,0,2.47-.02,3.2-.06s1.81-.14,3.24-.31h0Z"/>
                        <path class="cls-1" d="M170.59,95.21c-1.43,4.02-3.36,6.03-5.8,6.03-1.65,0-2.47-.94-2.47-2.83-1.27,1.89-2.91,2.83-4.91,2.83-1.46,0-2.66-.53-3.59-1.59s-1.4-2.47-1.4-4.23c0-2.45,1.03-4.84,3.08-7.17,2.05-2.34,4.13-3.5,6.24-3.5,1.95,0,3.13.89,3.57,2.67l.69-2.3h2.84l-3.12,10.9c-.43,1.54-.65,2.5-.65,2.88,0,.58.24.86.73.86,1.4,0,2.72-1.61,3.93-4.84l.85.29h0ZM164.51,88.45c0-1.89-.84-2.84-2.51-2.84-1.46,0-2.81,1.11-4.05,3.33-.81,1.48-1.43,2.97-1.86,4.48-.43,1.51-.65,2.78-.65,3.83,0,.96.22,1.69.65,2.2.43.51,1.05.76,1.86.76,1.76,0,3.23-1.19,4.42-3.58.46-.93,1-2.56,1.62-4.9.35-1.34.53-2.44.53-3.29h0Z"/>
                        <path class="cls-1" d="M181.78,85.98h-3.27l-3.3,12.02c-.13.34-.2.63-.2.88,0,.51.31.76.94.76,1.25,0,2.71-1.68,4.37-5.05l.82.37c-1.86,4.18-3.93,6.28-6.2,6.28-.81,0-1.47-.21-1.97-.64s-.75-.99-.75-1.68c0-.44.11-1.06.31-1.87l3.12-11.08h-2.66v-.86h2.94l1.17-4.35h2.92l-1.18,4.35h2.95v.86h0Z"/>
                        <path class="cls-1" d="M199.82,75.93c0,1.15-.49,1.72-1.46,1.72-1.14,0-1.7-.49-1.7-1.48,0-.33.04-.57.12-.74.08-.16.16-.31.24-.45,0-.33-.24-.49-.73-.49-2.11,0-4.01,3.54-5.72,10.63h3.61v.94h-3.85l-1.86,7.1c-1.54,5.85-2.97,9.93-4.3,12.23-1.57,2.71-3.54,4.06-5.92,4.06-.87,0-1.57-.22-2.11-.66s-.81-.98-.81-1.64c0-1.12.54-1.68,1.62-1.68.97,0,1.46.46,1.46,1.39,0,.27-.06.53-.18.78s-.18.41-.18.49c0,.27.26.41.77.41,1.32,0,2.46-.93,3.41-2.79.38-.74.8-2.11,1.28-4.12.47-2.01.98-4.19,1.52-6.54.54-2.35,1.3-5.36,2.27-9.03h-3.24v-.94h3.53c2.08-7.71,5.15-11.57,9.2-11.57.95,0,1.69.22,2.23.66s.81,1.01.81,1.72h-.01Z"/>
                        <path class="cls-1" d="M209.59,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.12-.57-4.24-1.71-1.12-1.14-1.68-2.53-1.68-4.18,0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM206.34,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.68-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M224.95,86.19c0,1.15-.55,1.72-1.65,1.72-.48,0-.92-.2-1.31-.59-.39-.4-.63-.6-.71-.6-.65,0-1.41.68-2.3,2.05-1.02,1.59-1.82,3.56-2.38,5.92l-1.45,6.03h-2.92l3.65-14.74h-2.84v-.86c.76,0,1.61,0,2.53-.02.93-.02,2.1-.15,3.51-.42l-1.16,4.34c.97-1.51,1.85-2.61,2.65-3.31.79-.7,1.62-1.05,2.49-1.05.57,0,1.02.15,1.37.45.35.3.53.66.53,1.07h0Z"/>
                        <path class="cls-1" d="M252.52,95.38c-1.3,3.91-3.26,5.87-5.88,5.87-1.59,0-2.39-.75-2.39-2.26,0-.49.14-1.22.41-2.17l2.28-7.95c.15-.69.22-1.22.22-1.6,0-.85-.53-1.27-1.58-1.27s-2.2.59-3.37,1.78-1.97,2.62-2.4,4.28l-2.28,8.66h-2.94l3-11.4c.05-.25.13-.55.22-.91s.14-.67.14-.91c0-1-.55-1.5-1.66-1.5s-2.16.59-3.3,1.76c-1.15,1.17-1.92,2.53-2.33,4.07l-2.38,8.91h-2.93l3.8-14.73h-2.99v-.86c2.16,0,4.24-.12,6.27-.37l-1.01,3.77c1.83-2.52,3.79-3.77,5.86-3.77,2.24,0,3.36,1.03,3.36,3.08v.74c1.7-2.54,3.66-3.81,5.88-3.81,1.11,0,1.96.25,2.55.74s.89,1.18.89,2.05c0,.55-.07,1.09-.2,1.64l-2.55,9.07c-.11.38-.16.68-.16.9,0,.41.24.62.73.62,1.32,0,2.66-1.57,4.01-4.72l.73.33v-.04Z"/>
                        <path class="cls-1" d="M287.87,73.92l-1.66,6.89h-1.01c.11-.61.17-1.04.18-1.3.01-.26.02-.47.02-.64,0-1.76-.51-2.89-1.54-3.39-.76-.36-2.46-.54-5.11-.54h-2.92l-2.84,11.2.77.04c3.06,0,5.03-1.4,5.92-4.19h1.1l-2.64,10.38h-1.05l.16-1.85c0-1.2-.31-2.04-.94-2.5-.62-.46-1.68-.7-3.18-.7h-.45l-3.14,12.35h3.04v1.03h-9.24v-1.03h2.35l6.28-24.74h-2.92v-1.03h18.81v.02Z"/>
                        <path class="cls-1" d="M297.47,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.12-.57-4.24-1.71s-1.68-2.53-1.68-4.18c0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM294.23,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.67-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M312.84,86.19c0,1.15-.55,1.72-1.65,1.72-.48,0-.92-.2-1.31-.59-.39-.4-.63-.6-.71-.6-.65,0-1.41.68-2.3,2.05-1.02,1.59-1.82,3.56-2.38,5.92l-1.45,6.03h-2.92l3.65-14.74h-2.84v-.86c.76,0,1.61,0,2.53-.02.93-.02,2.1-.15,3.51-.42l-1.16,4.34c.97-1.51,1.85-2.61,2.65-3.31.79-.7,1.62-1.05,2.49-1.05.57,0,1.02.15,1.37.45.35.3.53.66.53,1.07h0Z"/>
                        <path class="cls-1" d="M346.89,73.92l-1.66,6.89h-1.01c.11-.61.17-1.04.18-1.3.01-.26.02-.47.02-.64,0-1.76-.51-2.89-1.54-3.39-.76-.36-2.46-.54-5.11-.54h-2.92l-2.84,11.2.77.04c3.06,0,5.03-1.4,5.92-4.19h1.1l-2.64,10.38h-1.05l.16-1.85c0-1.2-.31-2.04-.94-2.5-.62-.46-1.68-.7-3.18-.7h-.45l-3.14,12.35h3.04v1.03h-9.24v-1.03h2.35l6.28-24.74h-2.92v-1.03h18.81v.02Z"/>
                        <path class="cls-1" d="M356.5,91.04c0,2.19-.81,4.35-2.43,6.46-1.95,2.5-4.34,3.74-7.18,3.74-1.7,0-3.11-.57-4.24-1.71-1.12-1.14-1.68-2.53-1.68-4.18,0-2.22.81-4.39,2.43-6.5,2.11-2.74,4.53-4.11,7.26-4.11,1.73,0,3.13.58,4.22,1.73,1.08,1.15,1.62,2.67,1.62,4.56h0ZM353.26,88.66c0-2.08-.91-3.13-2.72-3.13-.89,0-1.66.19-2.31.58-.65.38-1.2,1-1.66,1.85-.22.41-.45.93-.69,1.54-.24.62-.53,1.54-.85,2.78-.59,2.19-.89,3.85-.89,4.98,0,2.06.97,3.09,2.92,3.09.95,0,1.78-.25,2.49-.74.72-.49,1.28-1.19,1.68-2.1.68-1.51,1.18-3.04,1.52-4.61.34-1.56.51-2.98.51-4.24h0Z"/>
                        <path class="cls-1" d="M377.42,95.46c-.6,1.86-1.39,3.29-2.38,4.29s-2.06,1.5-3.2,1.5c-.87,0-1.56-.21-2.08-.62s-.77-.94-.77-1.6l.12-1.52c-1.94,2.49-3.93,3.73-5.98,3.73-1.1,0-1.96-.24-2.56-.72-.61-.48-.91-1.15-.91-2,0-.3.08-.76.25-1.36l2.79-11.16h-3.03v-.87c2.38,0,4.46-.12,6.24-.37l-3.28,12.76-.16,1c0,.95.53,1.42,1.58,1.42,1.35,0,2.6-.68,3.74-2.04,1.14-1.36,2.04-3.32,2.72-5.87l1.83-6.89h2.89l-3.24,12.47c-.14.49-.2.9-.2,1.23,0,.63.31.94.93.94,1.35,0,2.66-1.55,3.93-4.64l.77.33h0Z"/>
                        <path class="cls-1" d="M397.61,95.34c-.73,1.98-1.55,3.46-2.48,4.44-.93.98-2.04,1.47-3.33,1.47-.78,0-1.41-.2-1.88-.6s-.71-.94-.71-1.6c0-.47.07-1.05.2-1.75l2.41-8.4.26-1.33c0-1.05-.57-1.57-1.7-1.57s-2.3.62-3.5,1.86-2.06,2.82-2.57,4.75l-2.14,8.12h-2.97l3.81-14.73h-3v-.86c1.89,0,3.13-.02,3.73-.06.59-.04,1.45-.14,2.55-.31l-1.01,3.81c1.76-2.54,3.76-3.81,6-3.81,1.13,0,2.04.26,2.72.77.68.51,1.01,1.22,1.01,2.11,0,.22-.03.48-.08.79s-.12.63-.2.96l-2.59,9.03-.12.59c0,.51.27.76.81.76,1.38,0,2.72-1.59,4.01-4.76l.77.33h0Z"/>
                        <path class="cls-1" d="M418.56,73.55l-6.73,24.25c-.14.42-.2.73-.2.92,0,.67.34,1.01,1.01,1.01s1.34-.43,2.07-1.28c.73-.86,1.39-2.11,1.99-3.76l.93.37c-1.51,4.13-3.45,6.19-5.8,6.19-1.73,0-2.59-.86-2.59-2.58v-.21c-1.35,1.86-2.99,2.79-4.91,2.79-1.43,0-2.66-.55-3.67-1.66-1.01-1.1-1.52-2.49-1.52-4.15,0-2.35.96-4.68,2.89-7,2.03-2.46,4.22-3.68,6.55-3.68,1.71,0,2.86.66,3.46,1.98l3.27-11.94h-3.28v-.87c2.32,0,4.5-.12,6.53-.37h0ZM411.31,88.23c0-1.77-.85-2.66-2.55-2.66s-2.99,1.05-4.09,3.15c-.19.38-.43.94-.71,1.68s-.53,1.49-.75,2.25c-.62,2.18-.93,3.71-.93,4.58,0,1.99.86,2.99,2.59,2.99,2,0,3.57-1.46,4.7-4.38.57-1.42,1-2.88,1.3-4.4.3-1.51.45-2.58.45-3.21h-.01Z"/>
                    </svg>
                </svg>
            </div>  


            <div class="right-menu">
                <!-- 마이페이지 (로그인 후) -->
                <div class="mypage-btn" onclick="location.href='{% url 'mypage' %}'">
                    <svg class="mypage-icon" width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.24279 6.8065C9.09527 6.8065 9.91284 6.46786 10.5156 5.86506C11.1184 5.26226 11.4571 4.4447 11.4571 3.59222C11.4571 2.73973 11.1184 1.92217 10.5156 1.31937C9.91284 0.716577 9.09527 0.37793 8.24279 0.37793C7.39031 0.37793 6.57274 0.716577 5.96994 1.31937C5.36715 1.92217 5.0285 2.73973 5.0285 3.59222C5.0285 4.4447 5.36715 5.26226 5.96994 5.86506C6.57274 6.46786 7.39031 6.8065 8.24279 6.8065ZM0.742787 16.4494C0.742787 15.4644 0.936781 14.4892 1.31369 13.5792C1.6906 12.6693 2.24305 11.8425 2.93949 11.1461C3.63593 10.4496 4.46272 9.89717 5.37266 9.52026C6.2826 9.14335 7.25787 8.94936 8.24279 8.94936C9.2277 8.94936 10.203 9.14335 11.1129 9.52026C12.0229 9.89717 12.8496 10.4496 13.5461 11.1461C14.2425 11.8425 14.795 12.6693 15.1719 13.5792C15.5488 14.4892 15.7428 15.4644 15.7428 16.4494H0.742787Z" fill="#889DC4"/>
                    </svg>
                    <div class="mypage-btn-text">마이 페이지</div>  
                </div>
        

                <!-- 유료플랜 결제 -->
                <div class="payment-btn">
                    <svg class="payment-icon" width="23" height="22" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.7339 0.200195L13.2023 7.40581L18.9589 2.82986L15.452 9.29355L22.8032 9.48839L15.962 12.1857L21.4681 17.0602L14.4936 14.7291L15.5782 22.0023L11.7339 15.7335L7.88962 22.0023L8.97425 14.7291L1.9998 17.0602L7.50585 12.1857L0.664688 9.48839L8.01582 9.29355L4.50899 2.82986L10.2655 7.40581L11.7339 0.200195Z" fill="#889DC4"/>
                        </svg>
                    <div class="payment-btn-text">유료플랜 결제</div>
                </div>
            </div>


        </div>

        <div class="main-content-prompt">
            <div class="prompt-container">
                <div class="prompt-wrapper">

                </div>
            </div>

            <div class="input-container-prompt">
                <!-- 스크롤 버튼을 input-container-prompt 내부 상단으로 이동 -->
                <button id="scroll-down-btn" class="scroll-down-button" style="display: none;">
                    ↓
                </button>

                <!-- 응답 중단 버튼 추가 -->
                <button id="stop-streaming-btn" class="stop-streaming-button" style="display: none;">
                    ■
                </button>

                
                <textarea class="input-box-unlocked" placeholder="창업의 모든 것을 물어보세요"></textarea>

                <!-- Loading Spinner Element (Moved Here) -->
                <!-- <div id="loading-spinner" class="loading-spinner-overlay" style="display: none; position: absolute; top: 50%; right: 50px; transform: translateY(-50%); background: none; width: auto; height: auto; z-index: 10;">
                    <div class="spinner" style="width: 20px; height: 20px; border-width: 3px;"></div> /* Adjusted size */
                </div> -->

                <!-- 창플 아이콘 (input 미입력) -->
                <div class="changple-btn">
                    <svg class="changple-icon" width="30" height="34" viewBox="0 0 30 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.0019 26.0245C18.6708 26.0245 20.3233 25.6958 21.8651 25.0572C23.4069 24.4186 24.8078 23.4825 25.9879 22.3024C27.1679 21.1224 28.104 19.7215 28.7427 18.1796C29.3813 16.6378 29.71 14.9853 29.71 13.3165C29.71 11.6476 29.3813 9.99512 28.7427 8.4533C28.104 6.91149 27.1679 5.51056 25.9879 4.33051C24.8078 3.15045 23.4069 2.21438 21.8651 1.57574C20.3233 0.937102 18.6708 0.608398 17.0019 0.608398L17.0019 13.3165L17.0019 26.0245Z" fill="#90A4C8"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17 0.608398H0.290001V33.8249H17V26.0245C17 26.0245 17 26.0245 17 26.0245L17 13.3165V0.608402C17 0.608402 17 0.608398 17 0.608398ZM17 0.608398V26.0245C15.3312 26.0245 13.6787 25.6958 12.1369 25.0572C10.5951 24.4186 9.19414 23.4825 8.01408 22.3024C6.83403 21.1224 5.89796 19.7215 5.25932 18.1796C4.62068 16.6378 4.29197 14.9853 4.29197 13.3165C4.29197 11.6476 4.62068 9.99512 5.25932 8.45331C5.89796 6.91149 6.83403 5.51056 8.01408 4.33051C9.19413 3.15046 10.5951 2.21439 12.1369 1.57575C13.6787 0.937108 15.3312 0.608401 17 0.608398Z" fill="#90A4C8"/>
                    </svg>
                </div>

                <!--send btn 글자 입력시-->
                <div class="send-btn" style="display: none;">
                    <svg class="send-icon" width="23" height="26" viewBox="0 0 23 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1.03659 12.7966C0.741862 12.5018 0.576294 12.102 0.576294 11.6852C0.576294 11.2683 0.741862 10.8685 1.03659 10.5737L10.4693 1.14096C10.7641 0.846232 11.1639 0.680664 11.5808 0.680664C11.9977 0.680664 12.3975 0.846232 12.6923 1.14096L22.125 10.5737C22.4114 10.8702 22.5698 11.2673 22.5662 11.6795C22.5627 12.0917 22.3973 12.486 22.1058 12.7775C21.8143 13.069 21.42 13.2343 21.0078 13.2379C20.5956 13.2415 20.1985 13.083 19.902 12.7966L13.1529 6.04754V24.2621C13.1529 24.679 12.9873 25.0789 12.6924 25.3738C12.3976 25.6686 11.9977 25.8342 11.5808 25.8342C11.1638 25.8342 10.764 25.6686 10.4691 25.3738C10.1743 25.0789 10.0087 24.679 10.0087 24.2621V6.04754L3.25956 12.7966C2.96475 13.0914 2.56495 13.2569 2.14808 13.2569C1.73121 13.2569 1.3314 13.0914 1.03659 12.7966Z" fill="#617DAE"/>
                    </svg>
                </div>

                <!-- Locked Button (Initially Hidden) -->
                <div class="locked-btn" style="display: none;">
                    <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" width="27" height="30" viewBox="0 0 27 30" fill="none">
                        <path d="M13.4574 19.9639V22.9639M4.4574 28.9639H22.4574C23.253 28.9639 24.0161 28.6478 24.5787 28.0852C25.1413 27.5226 25.4574 26.7595 25.4574 25.9639V16.9639C25.4574 16.1682 25.1413 15.4052 24.5787 14.8425C24.0161 14.2799 23.253 13.9639 22.4574 13.9639H4.4574C3.66175 13.9639 2.89869 14.2799 2.33608 14.8425C1.77347 15.4052 1.4574 16.1682 1.4574 16.9639V25.9639C1.4574 26.7595 1.77347 27.5226 2.33608 28.0852C2.89869 28.6478 3.66175 28.9639 4.4574 28.9639ZM19.4574 13.9639V7.96387C19.4574 6.37257 18.8253 4.84644 17.7 3.72123C16.5748 2.59601 15.0487 1.96387 13.4574 1.96387C11.8661 1.96387 10.34 2.59601 9.21476 3.72123C8.08954 4.84644 7.4574 6.37257 7.4574 7.96387V13.9639H19.4574Z" stroke="#90A4C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Loading Spinner Element -->
         <div id="loading-spinner" class="loading-spinner-overlay" style="display: none;">
             <div class="spinner"></div>
         </div> 

    </div>

    <footer>
        <div class="company-info">
            (주)창플 | 283-88-00641 | 한범구 | 서울 송파구 송파대로 167 (문정동)테라타워 B동, 707호 | 02-2054-3956 | tiger9@changple.com
        </div>
        <div class="copyright">
            <p>
                @Copyright @ ChangpleTeamBusiness Inc. All Rights Reserved. 
            </p>
            <p>
                <a href="/privacy/" class="personal-info-link" target="_blank">개인정보처리방침</a>
            </P>
        </div>
    </footer>

    
    {% load static %}
    {# 외부 JavaScript 파일을 먼저 로드 #}
    <script src="{% static 'js/index_chat.js' %}"></script> 
    
    {# HTML 내부에 남겨둘 스크립트 #}
    <script>
        let abortController = null; // 스트리밍 중단 컨트롤러

        document.addEventListener('DOMContentLoaded', function() {
            // marked 렌더러 커스터마이징 (취소선 비활성화)
            const renderer = new marked.Renderer();
            renderer.del = function(text) {
              // text 인자의 타입과 내용 확인 (디버깅용)
              console.log('renderer.del input:', text, typeof text);

              // text가 객체이고 text.text 속성이 있다면 해당 값을 사용, 아니면 text 자체를 사용
              const actualText = (typeof text === 'object' && text !== null && typeof text.text === 'string') ? text.text : String(text);

              // <del> 태그 대신 원래 텍스트에 ~를 붙여 반환
              return `~${actualText}~`;
            };

            // marked 옵션 설정 - 커스텀 렌더러 적용
            marked.setOptions({
              renderer: renderer,
              gfm: true, // 다른 GFM 기능은 유지 (필요에 따라 조정)
              breaks: true // 줄바꿈 처리 등 (필요에 따라 조정)
            });

            // Load chat history from Django context if available
            {% if chat_history_json %}
                let chatHistory = {{ chat_history_json|safe }};
            {% else %}
                // Initialize empty chat history if none exists
                let chatHistory = [];
            {% endif %}
            
            // Load existing chat history from Django context and render messages
            {% if chat_history %}
                // Clear any existing messages first
                const promptWrapper = document.querySelector('.prompt-wrapper');
                if (promptWrapper) {
                    promptWrapper.innerHTML = '';
                }
                
                // Use a Set to track rendered messages and prevent duplicates
                const renderedMessages = new Set();
                
                // Render existing chat messages from the server
                {% for message in chat_history %}
                    // Create a unique key for this message - using var instead of const to avoid redeclaration errors
                    var messageKey = '{{ message.role }}' + '_' + '{{ forloop.counter }}';
                    
                    // Only render if not already rendered
                    if (!renderedMessages.has(messageKey)) {
                        renderedMessages.add(messageKey);
                        addMessageToChat('{{ message.role }}', `{{ message.content|escapejs }}`);
                        console.log("Rendered message:", messageKey, "{{ message.role }}");
                    }
                {% endfor %}
            {% endif %}
            
            // 세션 스토리지에서 대화 기록 복원 시도
            try {
                const savedHistory = sessionStorage.getItem('chatHistory_{{ chat_session.session_nonce }}');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    console.log("세션 스토리지에서 대화 기록 복원:", chatHistory.length, "개");
                    // 필요하다면 복원된 기록도 화면에 렌더링 (현재는 렌더링 로직 없음)
                }
            } catch (error) {
                console.error("대화 기록 복원 오류:", error);
            }
            
            // Initialize query count from server data
            let remainingQueries = {{ remaining_queries|default:0 }};
            let queryLimit = {{ query_limit|default:10 }};
            let isPremium = {{ is_premium|default:"false" }};
            let one_o_one_condition = false; // 조건 변수 추가 및 false로 초기화
            
            const loadingSpinner = document.getElementById('loading-spinner'); // 스피너 요소 참조
            
             // Chat API 호출 함수 (스트리밍 방식)
            async function callChatAPI(query, isInitialMessage = false) {
                // Show spinner
                // if (loadingSpinner) loadingSpinner.style.display = 'flex'; // 스피너 표시 - REMOVED

                // --- 로딩 시 UI 변경 (입력창 비활성화, 버튼 상태 변경) ---
                const inputBox = document.querySelector('.input-box-unlocked'); // inputBox 참조는 유지 (값 사용 위해)
            
                const stopStreamingBtn = document.getElementById('stop-streaming-btn'); // 중단 버튼 참조는 유지

                if(stopStreamingBtn) stopStreamingBtn.style.display = 'flex'; // 중단 버튼 표시는 유지

                if (!isInitialMessage) {
                    addMessageToChat('user', query); // index_chat.js 함수 호출
                }

                // AI 응답 메시지 영역 미리 생성 및 ID 가져오기
                const aiContentSpanId = addMessageToChat('assistant', '', true); // Pass showSpinner=true

                if (!aiContentSpanId) {
                    console.error("AI 메시지 영역 생성 실패");
                    // if (loadingSpinner) loadingSpinner.style.display = 'none'; // 스피너 숨김 - REMOVED
                     // --- 로딩 종료 시 UI 복원 (중단 버튼만) ---
                     if(stopStreamingBtn) stopStreamingBtn.style.display = 'none'; // 중단 버튼 숨김
                     // --- 로딩 종료 시 UI 복원 끝 ---
                    return;
                }

                const aiContentSpan = document.getElementById(aiContentSpanId);
                let accumulatedResponse = '';
                abortController = new AbortController(); // 새 AbortController 생성
                let spinnerHidden = false; // Flag to track if spinner has been hidden
                let aiMessageDiv = null; // Reference to the assistant message div

                try {
                    // Find the message div containing the spinner
                    const aiContentSpanElement = document.getElementById(aiContentSpanId);
                    if (aiContentSpanElement) {
                        aiMessageDiv = aiContentSpanElement.closest('.prompt-p');
                    }

                    const response = await fetch('/api/chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken') // index_chat.js 함수 호출
                        },
                        body: JSON.stringify({
                            query: query,
                            session_nonce: "{{ chat_session.session_nonce }}"
                        }),
                        signal: abortController.signal // AbortSignal 연결
                    });

                    if (!response.ok) {
                        // HTTP 에러 처리 (like 4xx, 5xx)
                        const errorData = await response.json().catch(() => ({ error: `HTTP 오류: ${response.status}` }));
                        console.error('HTTP Error:', response.status, errorData);
                        if (aiContentSpan) aiContentSpan.textContent = `오류가 발생했습니다: ${errorData.error || response.statusText}`;
                        
                        // 쿼리 카운트 업데이트 시도
                        if (errorData.remaining_queries !== undefined) {
                           remainingQueries = errorData.remaining_queries;
                           queryLimit = errorData.query_limit || queryLimit;
                           isPremium = errorData.is_premium || isPremium;
                           addFreeUseCount(remainingQueries, queryLimit);
                        }
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) {
                            console.log('Stream finished.');
                            break;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const messages = buffer.split('\n\n');
                        buffer = messages.pop(); // 마지막 불완전한 메시지 보관

                        for (const message of messages) {
                            if (message.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(message.slice(6));

                                    if (data.token) {
                                        accumulatedResponse += data.token;
                                        if (aiContentSpan) {
                                            // 이전: aiContentSpan.textContent = accumulatedResponse;
                                            // 변경: 스트리밍 중 마크다운 실시간 렌더링
                                            aiContentSpan.innerHTML = DOMPurify.sanitize(marked.parse(accumulatedResponse));
                                        }
                                    } else if (data.end) {
                                        console.log('End signal received.');
                                        // Final updates, ensure spinner/status hidden
                                        if (!spinnerHidden && aiMessageDiv) {
                                            const spinnerContainer = aiMessageDiv.querySelector('.spinner-container');
                                            if (spinnerContainer) spinnerContainer.style.display = 'none';
                                            if (contentSpan) contentSpan.style.display = 'inline';
                                        }
                                        
                                        // Log document information if available
                                        if (data.documents && Array.isArray(data.documents) && data.documents.length > 0) {
                                            console.log('Retrieved documents:');
                                            data.documents.forEach((doc, index) => {
                                                console.log(`${index + 1}. ${doc.title} (${doc.source})`);
                                            });
                                            
                                            // Create the source toggle container according to designer's structure
                                            const sourceToggleHTML = `
                                            <div class="source-toggle-container">
                                                <div class="toggle-area">
                                                    <button class="toggle-icon">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#617DAE" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                                            <polyline points="9 6 15 12 9 18"></polyline>
                                                        </svg>
                                                    </button>
                                                    <div class="toggle-text">
                                                        <p>출처 보기</p>
                                                    </div>
                                                </div>
                                                <div class="source-list-area" style="display: none;">
                                                    ${data.documents.map((doc, index) => `
                                                        <div class="source-list-item-${index + 1}">
                                                            <p>[${index + 1}]</p>
                                                            <p>
                                                                <a href="${doc.source}" target="_blank" style="color: #617DAE; text-decoration: none;">
                                                                    ${doc.title}
                                                                </a>
                                                            </p>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>`;
                                            
                                            // Add the CSS styles
                                            const styleElement = document.createElement('style');
                                            styleElement.textContent = `
                                                .source-toggle-container {
                                                    display: flex;
                                                    flex-direction: column;
                                                    width: 100%;
                                                    padding-bottom: 20px;
                                                    padding-left: 40px;
                                                    margin-top: 0px;
                                                    margin-bottom: 10px;
                                                    gap: 10px;
                                                }
                                                
                                                .toggle-area {
                                                    display: flex;
                                                    flex-direction: row;
                                                    align-items: center;
                                                    width: 100%;
                                                    height: 36px;
                                                    gap: 14px;
                                                    padding-left: 4px;
                                                }
                                                
                                                .toggle-icon {
                                                    width: 34px;
                                                    height: 34px;
                                                    border-radius: 4px;
                                                    outline-width: 1px;
                                                    outline-style: solid;
                                                    outline-color: #617dae;
                                                    display: flex;
                                                    flex-direction: column;
                                                    align-items: center;
                                                    justify-content: center;
                                                    appearance: none;
                                                    -webkit-appearance: none;
                                                    -moz-appearance: none;
                                                    background: none;
                                                    border: none;
                                                    cursor: pointer;
                                                }
                                                
                                                .toggle-text {
                                                    font-size: 16px;
                                                    color: #617dae;
                                                }
                                                
                                                .toggle-text p {
                                                    margin: 0;
                                                }
                                                
                                                .source-list-area {
                                                    display: flex;
                                                    flex-direction: column;
                                                    width: 100%;
                                                    padding-left: 54px;
                                                    align-items: flex-start;
                                                    gap: 16px;
                                                }
                                                
                                                .source-list-area > div {
                                                    display: flex;
                                                    align-items: flex-start;
                                                    gap: 8px;
                                                }
                                                
                                                .source-list-area p {
                                                    color: #617dae;
                                                    margin: 0;
                                                }

                                                /* Update free-use-count-container styles */
                                                .free-use-count-container {
                                                    display: flex;
                                                    flex-direction: row;
                                                    align-items: flex-start;
                                                    padding-left: 40px;
                                                    padding-bottom: 20px;
                                                    gap: 10px;
                                                }
                                            `;
                                            
                                            // Add elements to the DOM
                                            document.head.appendChild(styleElement);
                                            
                                            // Insert the source toggle HTML directly
                                            const promptContainer = document.querySelector('.prompt-wrapper');
                                            if (promptContainer) {
                                                promptContainer.insertAdjacentHTML('beforeend', sourceToggleHTML);
                                                // Scroll the new element into view
                                                const newToggle = promptContainer.lastElementChild;
                                                if (newToggle && newToggle.classList.contains('source-toggle-container')) {
                                                    newToggle.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                                }
                                            }
                                        } else {
                                            console.log('No documents retrieved or available');
                                        }
                                        
                                        // Update query counts etc.
                                        if (data.remaining_queries !== undefined) {
                                            remainingQueries = data.remaining_queries;
                                            queryLimit = data.query_limit || queryLimit;
                                            isPremium = data.is_premium || isPremium;
                                            addFreeUseCount(remainingQueries, queryLimit);
                                        }
                                        // 스트림 종료 처리 (break는 while 루프를 빠져나가 finally로 감)
                                        await reader.cancel(); // 리더 명시적 종료
                                        break; // for 루프 종료
                                    } else if (data.error) {
                                        console.error('Stream Error:', data.error);
                                        if (aiContentSpan) aiContentSpan.textContent = `스트리밍 중 오류: ${data.error}`;
                                        await reader.cancel();
                                        throw new Error(data.error); // 오류 발생 시 스트림 처리 중단
                                    }

                                    // Hide spinner and show content span on first data arrival
                                    if (!spinnerHidden && (data.token || data.end || data.error)) {
                                        if (aiMessageDiv) {
                                            const spinnerContainer = aiMessageDiv.querySelector('.spinner-container');
                                            if (spinnerContainer) spinnerContainer.remove();
                                        }
                                        const contentSpan = document.getElementById(aiContentSpanId);
                                        if (contentSpan) contentSpan.style.display = 'inline'; // Or 'block' depending on desired layout
                                        
                                        spinnerHidden = true;
                                    }
                                } catch (e) {
                                    console.error('Error parsing message:', message, e);
                                }
                            }
                        }
                         if (abortController.signal.aborted) { // 외부에서 중단 시켰는지 확인
                            console.log('Stream aborted by user.');
                            await reader.cancel();
                            throw new Error('AbortError');
                         }
                    }
                } catch (error) {
                     console.error('Error during fetch or stream processing:', error);
                     if (aiMessageDiv) {
                           // Remove spinner on error as well, if not already removed
                           if (!spinnerHidden) {
                               const spinnerContainer = aiMessageDiv.querySelector('.spinner-container');
                               if (spinnerContainer) spinnerContainer.remove();
                               const contentSpan = document.getElementById(aiContentSpanId);
                               if (contentSpan) contentSpan.style.display = 'inline'; // Show span for error message
                               spinnerHidden = true;
                           }
 
                          // AbortError가 *아닌* 경우에만 여기서 오류 메시지 설정
                          if (!(error.message === 'AbortError' || error.name === 'AbortError')) {
                               const contentSpan = document.getElementById(aiContentSpanId);
                               if (contentSpan && !contentSpan.textContent.startsWith('오류') && !contentSpan.textContent.startsWith('스트리밍 중 오류')) {
                                   // 이미 오류 메시지가 표시되지 않은 경우에만 기본 오류 메시지 표시
                                   contentSpan.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
                               }
                          }
                          // AbortError의 경우, finally 블록에서 최종 메시지를 처리합니다.
                      }

                } finally {
                    
                    // Ensure spinner is hidden if it wasn't already (e.g., due to immediate error before first chunk)
                    // if (loadingSpinner && !spinnerHidden) {
                    //     loadingSpinner.style.display = 'none'; 
                    // } - REMOVED
 
                    // Ensure spinner inside message is removed if loop was exited early
                    if (!spinnerHidden && aiMessageDiv) {
                        const spinnerContainer = aiMessageDiv.querySelector('.spinner-container');
                        if (spinnerContainer) spinnerContainer.remove();
                        const contentSpan = document.getElementById(aiContentSpanId);
                        if (contentSpan) contentSpan.style.display = 'inline';
                    }

                    const wasAborted = abortController && abortController.signal.aborted;

                    // --- 로딩 종료 시 UI 복원 (중단 버튼만) ---
                    if(stopStreamingBtn) stopStreamingBtn.style.display = 'none'; // 중단 버튼 숨김
                     // --- 로딩 종료 시 UI 복원 끝 ---

                    // 최종 렌더링 (오류가 없었거나 중단된 경우)
                    if (aiContentSpan && !aiContentSpan.textContent.startsWith('오류') && !aiContentSpan.textContent.startsWith('스트리밍 중 오류')) {
                         aiContentSpan.innerHTML = DOMPurify.sanitize(marked.parse(accumulatedResponse + (wasAborted ? '\n\n**(응답 생성 중단됨)**' : '')));
                        // 최종 스크롤 (렌더링 후)
                        aiContentSpan.parentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    // 카운트 업데이트 및 스크롤
                    addFreeUseCount(remainingQueries, queryLimit);

                    // 모든 작업 완료 후 abortController를 null로 설정
                    abortController = null;
                }
            }

            // 무료 사용 카운트 추가 함수 (openConsultationModal 호출 필요, HTML에 남김)
             function addFreeUseCount(remainingCount, totalLimit) {
                // *** HIDE free use count display ***
                // Commenting out the entire function body to prevent display
                /*
                // 이전 카운트 메시지 제거
                const existingCounters = document.querySelectorAll('.free-use-count-container');
                existingCounters.forEach(counter => counter.remove());

                // Use function parameters or default to global variables
                const count = remainingCount !== undefined ? remainingCount : remainingQueries;
                const limit = totalLimit !== undefined ? totalLimit : queryLimit;
                
                const promptContainer = document.querySelector('.prompt-wrapper');
                if (!promptContainer) return;
                
                // 고유 ID 생성
                const counterId = 'free-use-count-' + Date.now();
                let buttonId = null; // 버튼 ID 변수 초기화
                
                let displayText = `무료 사용(${count}/${limit})`;
                if (isPremium) {
                    displayText = "프리미엄 이용자";
                } else if (count <= 0) {
                    displayText = "무료 사용량 소진";
                    // 여기에 필요한 경우 1:1 상담 버튼 로직 추가 가능
                    // one_o_one_condition = true; // 예시
                }


                let buttonHTML = ''; // 버튼 HTML 초기화

                // one_o_one_condition이 true일 때만 버튼 HTML 생성 및 ID 할당
                if (one_o_one_condition) {
                    buttonId = 'open-consultation-modal-' + Date.now();
                    buttonHTML = `
                        <div class="free-use-count">
                            <p id="${buttonId}" class="consultation-btn" role="button" tabindex="0">1:1 상담 신청</p>
                        </div>
                    `;
                }
                
                // 최종 HTML 구성 (버튼 HTML은 조건에 따라 포함되거나 비어있음)
                const freeUseCountHTML = `
                    <div id="${counterId}" class="free-use-count-container">
                        <div class="free-use-count">
                            <p>${displayText}</p>
                        </div>
                        ${buttonHTML} 
                    </div>
                `;
                
                promptContainer.insertAdjacentHTML('beforeend', freeUseCountHTML);
                
                // 버튼이 실제로 추가되었을 경우 (one_o_one_condition이 true였을 경우)에만 이벤트 리스너 추가
                if (one_o_one_condition && buttonId) {
                    const buttonElement = document.getElementById(buttonId);
                    if (buttonElement) { // 버튼 요소가 존재하는지 확인
                        buttonElement.addEventListener('click', function() {
                            openConsultationModal(); // index_chat.js 함수 호출
                        });
                        
                        // 키보드 접근성 이벤트 리스너 추가
                        buttonElement.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                this.click();
                            }
                        });
                    }
                }
                 // 새 메시지(카운터)로 스크롤
                 const element = document.getElementById(counterId);
                  if (element) {
                     element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
                 */
            }

             // 상담 신청 요청 보내기 (session_nonce 때문에 HTML에 남김)
            function sendConsultationRequest() {
                console.log("Sending consultation request");
                const userEmailInput = document.getElementById('user-email');
                const additionalMessageInput = document.getElementById('additional-message');
                const userEmail = userEmailInput ? userEmailInput.value : '';
                const additionalMessage = additionalMessageInput ? additionalMessageInput.value : '';

                console.log("Email:", userEmail);
                
                // 모달 내용을 로딩 상태로 변경
                const modalContent = document.querySelector('#consultation-modal .modal-content');
                 if (!modalContent) return;
                const originalContent = modalContent.innerHTML;
                modalContent.innerHTML = '<div style="text-align: center; padding: 20px;"><p>상담 요청을 전송 중입니다...</p></div>';
                
                const requestData = {
                    user_email: userEmail,
                    session_nonce: "{{ chat_session.session_nonce }}", // Django 템플릿 변수 사용
                    message: additionalMessage
                };
                console.log("Request data:", requestData);
                
                // API 요청 보내기
                fetch('/notifications/api/consultation-request/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // index_chat.js 함수 호출
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                         // Handle HTTP errors (like 404, 500)
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Response data:", data);
                    // 성공 또는 오류 메시지 표시
                    if (data.status === 'success') {
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <h3>상담 요청이 성공적으로 전송되었습니다</h3>
                                <p>이메일 주소로 답변을 보내드리겠습니다: ${userEmail}</p>
                                <button id="close-success-modal" class="submit-btn">닫기</button>
                            </div>
                        `;
                        const closeSuccessBtn = document.getElementById('close-success-modal');
                        if (closeSuccessBtn) {
                           closeSuccessBtn.addEventListener('click', function() {
                                const modal = document.getElementById('consultation-modal');
                                if(modal) modal.style.display = 'none';
                           });
                        }
                    } else {
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <h3>오류가 발생했습니다</h3>
                                <p>${data.error || '상담 요청을 처리하는 중 오류가 발생했습니다.'}</p>
                                <button id="try-again-btn" class="submit-btn">다시 시도하기</button>
                            </div>
                        `;
                        const tryAgainBtn = document.getElementById('try-again-btn');
                        if (tryAgainBtn) {
                           tryAgainBtn.addEventListener('click', function() {
                                modalContent.innerHTML = originalContent;
                                // 이벤트 리스너 다시 추가 (openConsultationModal에서 처리하므로 여기선 복원만)
                                // 주의: 원래 폼/닫기 이벤트 리스너를 다시 붙여야 할 수 있음
                                // openConsultationModal을 다시 호출하는 것이 더 안전할 수 있음
                                // 여기서는 간단히 내용만 복원
                           });
                        }
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                     modalContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h3>오류가 발생했습니다</h3>
                            <p>네트워크 오류 또는 처리 중 문제가 발생했습니다.</p>
                            <button id="try-again-error-btn" class="submit-btn">다시 시도하기</button>
                        </div>
                    `;
                     const tryAgainErrorBtn = document.getElementById('try-again-error-btn');
                     if (tryAgainErrorBtn) {
                        tryAgainErrorBtn.addEventListener('click', function() {
                           modalContent.innerHTML = originalContent;
                           // 이벤트 리스너 다시 추가 필요
                        });
                     }
                });
            }

             // --- 초기 메시지 처리 로직 ---
            {% if initial_message %}
                // Check if we have an initial user message but no AI response yet
                // Only make API call if this is a brand new chat or we have the new_chat parameter
                {% if chat_history|length == 1 and chat_history.0.role == 'user' and not is_from_history or request.GET.new_chat == '1' %}
                    const initialMessage = "{{ initial_message|escapejs }}";
                    if (initialMessage) {
                        console.log("Initial message detected, calling API...");
                        // Log debug info about the request
                        console.log("From history:", {{ is_from_history|yesno:"true,false" }});
                        console.log("Chat history length:", {{ chat_history|length }});
                        console.log("First message role:", "{{ chat_history.0.role }}");
                        console.log("New chat parameter:", "{{ request.GET.new_chat|default:'not set' }}");
                        
                        // Add a small delay to make sure the UI is ready before making the API call
                        setTimeout(() => {
                            callChatAPI(initialMessage, true);
                        }, 100);
                    }
                {% else %}
                    console.log("Skipping automatic API call - conditions not met:");
                    console.log("From history:", {{ is_from_history|yesno:"true,false" }});
                    console.log("Chat history length:", {{ chat_history|length }});
                    {% if chat_history.0 %}console.log("First message role:", "{{ chat_history.0.role }}");{% endif %}
                    console.log("New chat parameter:", "{{ request.GET.new_chat|default:'not set' }}");
                {% endif %}
            {% endif %}
            
            // --- DOM 요소 가져오기 및 이벤트 리스너 설정 ---
            const inputBox = document.querySelector('.input-box-unlocked');
            const sendBtn = document.querySelector('.send-btn');
            const changpleBtn = document.querySelector('.changple-btn');
            const promptContainer = document.querySelector('.prompt-container');
            const scrollDownBtn = document.getElementById('scroll-down-btn');
            const cpLogoContainer = document.getElementById('cp-logo');
            //const helpBtn = document.querySelector('.help-btn');
            //const helpBox = document.getElementById('help-box');
            const stopStreamingBtn = document.getElementById('stop-streaming-btn'); // 중단 버튼 참조

            // 입력 필드 이벤트 리스너 (adjustTextareaHeight는 index_chat.js에 정의됨)
            if (inputBox) {
                inputBox.placeholder = "추가 질문을 입력하세요"; // Placeholder 변경
                const initialHeight = inputBox.style.height; // 초기 높이 저장

                inputBox.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                         if(changpleBtn) changpleBtn.style.display = 'none';
                         if(sendBtn) sendBtn.style.display = 'flex';
                    } else {
                         if(changpleBtn) changpleBtn.style.display = 'flex';
                         if(sendBtn) sendBtn.style.display = 'none';
                    }
                    adjustTextareaHeight(); // index_chat.js 함수 호출
                });

                // Adjust height on initial load
                adjustTextareaHeight(); // index_chat.js 함수 호출

                // Trigger input event to set initial button state
                inputBox.dispatchEvent(new Event('input'));

                // 엔터키 이벤트 (callChatAPI는 HTML 내에 정의됨)
                inputBox.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        const message = this.value.trim();
                        if (message) {
                            callChatAPI(message); // HTML 내 함수 호출
                            this.value = '';
                            adjustTextareaHeight(); // index_chat.js 함수 호출
                        }
                    } else {
                         adjustTextareaHeight(); // index_chat.js 함수 호출
                    }
                });
            }
            
            // 전송 버튼 클릭 이벤트 (callChatAPI는 HTML 내에 정의됨)
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    const message = inputBox ? inputBox.value.trim() : '';
                    if (message) {
                        callChatAPI(message); // HTML 내 함수 호출
                        if (inputBox) inputBox.value = '';
                        adjustTextareaHeight(); // index_chat.js 함수 호출
                    }
                });
            }
            
            // 스크롤 이벤트 리스너
            if (promptContainer && scrollDownBtn) {
                promptContainer.addEventListener('scroll', function() {
                    const scrollHeight = promptContainer.scrollHeight;
                    const scrollTop = promptContainer.scrollTop;
                    const clientHeight = promptContainer.clientHeight;
                    const isNearBottom = scrollTop + clientHeight >= scrollHeight - 10; 
                    const showButtonThreshold = 0.8; 
                    const currentScrollRatio = (scrollTop + clientHeight) / scrollHeight;

                    if (!isNearBottom && currentScrollRatio < showButtonThreshold) {
                        scrollDownBtn.classList.add('visible');
                        scrollDownBtn.style.display = 'flex';
                    } else {
                        scrollDownBtn.classList.remove('visible');
                        setTimeout(() => {
                            if (!scrollDownBtn.classList.contains('visible')) {
                                 scrollDownBtn.style.display = 'none';
                            }
                        }, 300); 
                    }
                });

                // 스크롤 버튼 클릭 이벤트 리스너
                scrollDownBtn.addEventListener('click', function() {
                    promptContainer.scrollTo({
                        top: promptContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            }

            // cp-logo-container 클릭 이벤트 리스너 추가
                if (cpLogoContainer) {
                    cpLogoContainer.addEventListener('click', function() {
                        // 현재 호스트와 포트를 동적으로 가져오기
                        const currentHost = window.location.hostname;
                        const currentPort = window.location.port;
                        const protocol = window.location.protocol;
                        let baseUrl = `${protocol}//${currentHost}`;
                        if (currentPort) {
                            baseUrl += `:${currentPort}`;
                        }
                        location.href = `${baseUrl}/`; // 루트 URL로 이동
                    });
                }
         
            // Help Box 이벤트 리스너 추가
            const helpBtn = document.querySelector('.help-btn');
            const helpBox = document.getElementById('help-box');

            // Only set up event listeners if both elements exist
            if (helpBtn && helpBox) {
                // Show or hide help box when help button is clicked
                helpBtn.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent the click from bubbling up to the document
                    helpBox.classList.toggle('visible');
                });

                // Hide help box when clicking anywhere else
                document.addEventListener('click', function(event) {
                    if (!helpBtn.contains(event.target) && !helpBox.contains(event.target)) {
                        helpBox.classList.remove('visible');
                    }
                });
            } else {
                console.log("Help button or help box elements not found");
            }

            // --- 스트리밍 중단 버튼 이벤트 리스너 추가 ---
            if (stopStreamingBtn) {
                stopStreamingBtn.addEventListener('click', function() {
                    if (abortController) {
                        abortController.abort(); // 스트리밍 중단 요청
                    } else {
                        console.log("Stop button clicked, but no active stream to abort.");
                    }
                });
            }
            // --- 스트리밍 중단 버튼 이벤트 리스너 추가 끝 ---

            // *** ADD: Event Delegation for Source Toggles ***
            if (promptContainer) { // Make sure promptContainer is defined in this scope
                promptContainer.addEventListener('click', function(event) {
                    // Find the closest ancestor element that is the toggle icon
                    const toggleIcon = event.target.closest('.toggle-icon');

                    // If the click happened on or inside a toggle icon
                    if (toggleIcon) {
                        // Find the parent container for this specific toggle instance
                        const sourceToggleContainer = toggleIcon.closest('.source-toggle-container');
                        if (sourceToggleContainer) {
                            // Find the list area within this specific toggle instance
                            const sourceListArea = sourceToggleContainer.querySelector('.source-list-area');
                            if (sourceListArea) {
                                // --- Toggle Logic ---
                                const isHidden = sourceListArea.style.display === 'none';
                                sourceListArea.style.display = isHidden ? 'flex' : 'none';

                                // Change arrow direction based on new state
                                if (isHidden) {
                                    // Opening: show down arrow
                                    toggleIcon.innerHTML = `
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#617DAE" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    `;
                                } else {
                                    // Closing: show right arrow
                                    toggleIcon.innerHTML = `
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#617DAE" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="9 6 15 12 9 18"></polyline>
                                        </svg>
                                    `;
                                }
                                // --- End Toggle Logic ---
                            }
                        }
                    }
                });
            }
            // *** END: Event Delegation ***

        }); // End of DOMContentLoaded listener
                    
        //---------- changple btn 호버 -------------------------
        document.addEventListener('DOMContentLoaded', function() {
            // changple-btn 요소 선택
            const changpleBtn = document.querySelector('.changple-btn');
            
            // 마우스가 버튼 위에 올라갔을 때 (mouseover)
            changpleBtn.addEventListener('mouseover', function() {
                // 배경색 변경 (예: 연한 파란색)
                this.style.backgroundColor = '#EFF2FA';
                // 부드러운 전환 효과 추가
                this.style.transition = 'background-color 0.3s ease';
            });
            
            // 마우스가 버튼에서 벗어났을 때 (mouseout)
            changpleBtn.addEventListener('mouseout', function() {
                // 원래 배경색으로 복원 (투명 또는 흰색)
                this.style.backgroundColor = 'transparent';
            });
        });

        //---------- send btn 호버 -------------------------
        document.addEventListener('DOMContentLoaded', function() {
            //-- send-btn 요소 선택
            const sendBtn = document.querySelector('.send-btn');
            
            //-- 마우스가 버튼 위에 올라갔을 때(mouseover)
            sendBtn.addEventListener('mouseover', function() {
                //-- 배경색 변경
                this.style.backgroundColor = '#EFF2FA';
                //-- 전환효과 추가
                this.style.transition = 'background-color 0.3 ease'; 
            });

            sendBtn.addEventListener('mouseout', function() {
                //-- 원래 배경색으로 보원
                this.style.backgroundColor = 'transparent';
            });
        });


        //--- mypage-btn hover -------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            //-- send-btn 요소 선택
            const mypageBtn = document.querySelector('.mypage-btn');
            
            //-- 마우스가 버튼 위에 올라갔을 때(mouseover)
            mypageBtn.addEventListener('mouseover', function() {
                //-- 배경색 변경
                this.style.backgroundColor = '#f5f5f5';
                //-- 전환효과 추가
                this.style.transition = 'background-color 0.3 ease'; 
            });

            mypageBtn.addEventListener('mouseout', function() {
                //-- 원래 배경색으로 보원
                this.style.backgroundColor = 'transparent';
            });
        });


        //--- payment-btn hover -------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            //-- send-btn 요소 선택
            const paymentBtn = document.querySelector('.payment-btn');
            
            //-- 마우스가 버튼 위에 올라갔을 때(mouseover)
            paymentBtn.addEventListener('mouseover', function() {
                //-- 배경색 변경
                this.style.backgroundColor = '#f5f5f5';
                //-- 전환효과 추가
                this.style.transition = 'background-color 0.3 ease'; 
            });

            paymentBtn.addEventListener('mouseout', function() {
                //-- 원래 배경색으로 보원
                this.style.backgroundColor = 'transparent';
            });
        });















        //-- send-btn 요소 선택
        const sendBtn = document.querySelector('.send-btn');










    </script>
</body>
</html>