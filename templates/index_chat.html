<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChangpleAI</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/index_chat.css' %}">
    <!-- 마크다운 변환 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- XSS 공격 방지를 위한 DOMPurify 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <style>
        /* 마크다운 렌더링을 위한 스타일 */
        .prompt-p h1, .prompt-p h2, .prompt-p h3 {
            margin: 10px 0;
            text-align: left;
        }
        
        .prompt-p code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .prompt-p pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            text-align: left;
        }
        
        .prompt-p blockquote {
            border-left: 4px solid #ccc;
            margin-left: 0;
            padding-left: 10px;
            color: #666;
            text-align: left;
        }
        
        .prompt-p a {
            color: #0366d6;
            text-decoration: none;
        }
        
        .prompt-p a:hover {
            text-decoration: underline;
        }
        
        .prompt-p ul, .prompt-p ol {
            text-align: left;
            padding-left: 20px;
        }
        
        .prompt-p hr {
            border: 0;
            height: 1px;
            background: #ccc;
            margin: 10px 0;
        }
        
        /* 상담 요청 관련 스타일 */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .submit-btn {
            background-color: #889DC4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .submit-btn:hover {
            background-color: #617DAE;
        }
        .consultation-btn {
            background-color: #889DC4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        .consultation-btn:hover {
            background-color: #617DAE;
        }
        .consultation-request-button {
            display: inline-block;
            margin-left: 10px;
        }
        .free-use-count-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- 마이페이지 (로그인 후) -->
            <div class="mypage-btn">
                <svg class="mypage-icon" width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.24279 6.8065C9.09527 6.8065 9.91284 6.46786 10.5156 5.86506C11.1184 5.26226 11.4571 4.4447 11.4571 3.59222C11.4571 2.73973 11.1184 1.92217 10.5156 1.31937C9.91284 0.716577 9.09527 0.37793 8.24279 0.37793C7.39031 0.37793 6.57274 0.716577 5.96994 1.31937C5.36715 1.92217 5.0285 2.73973 5.0285 3.59222C5.0285 4.4447 5.36715 5.26226 5.96994 5.86506C6.57274 6.46786 7.39031 6.8065 8.24279 6.8065ZM0.742787 16.4494C0.742787 15.4644 0.936781 14.4892 1.31369 13.5792C1.6906 12.6693 2.24305 11.8425 2.93949 11.1461C3.63593 10.4496 4.46272 9.89717 5.37266 9.52026C6.2826 9.14335 7.25787 8.94936 8.24279 8.94936C9.2277 8.94936 10.203 9.14335 11.1129 9.52026C12.0229 9.89717 12.8496 10.4496 13.5461 11.1461C14.2425 11.8425 14.795 12.6693 15.1719 13.5792C15.5488 14.4892 15.7428 15.4644 15.7428 16.4494H0.742787Z" fill="#889DC4"/>
                </svg>
                <div class="mypage-btn-text">마이 페이지</div>  
            </div>

            <!-- 유료플랜 결제 -->
            <div class="payment-btn">
                <svg class="payment-icon" width="23" height="22" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.7339 0.200195L13.2023 7.40581L18.9589 2.82986L15.452 9.29355L22.8032 9.48839L15.962 12.1857L21.4681 17.0602L14.4936 14.7291L15.5782 22.0023L11.7339 15.7335L7.88962 22.0023L8.97425 14.7291L1.9998 17.0602L7.50585 12.1857L0.664688 9.48839L8.01582 9.29355L4.50899 2.82986L10.2655 7.40581L11.7339 0.200195Z" fill="#889DC4"/>
                    </svg>
                <div class="payment-btn-text">유료플랜 결제</div>
            </div>
        </div>

        <div class="main-content-prompt">
            <div class="prompt-container">
                <div class="prompt-wrapper">

                </div>
            </div>

            <div class="input-container-prompt">
                <input type="text" class="input-box-unlocked" placeholder="창업의 모든 것을 물어보세요" />
                
                <!-- 창플 아이콘 (input 미입력) -->
                <div class="changple-btn">
                    <svg class="changple-icon" width="30" height="34" viewBox="0 0 30 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.0019 26.0245C18.6708 26.0245 20.3233 25.6958 21.8651 25.0572C23.4069 24.4186 24.8078 23.4825 25.9879 22.3024C27.1679 21.1224 28.104 19.7215 28.7427 18.1796C29.3813 16.6378 29.71 14.9853 29.71 13.3165C29.71 11.6476 29.3813 9.99512 28.7427 8.4533C28.104 6.91149 27.1679 5.51056 25.9879 4.33051C24.8078 3.15045 23.4069 2.21438 21.8651 1.57574C20.3233 0.937102 18.6708 0.608398 17.0019 0.608398L17.0019 13.3165L17.0019 26.0245Z" fill="#90A4C8"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17 0.608398H0.290001V33.8249H17V26.0245C17 26.0245 17 26.0245 17 26.0245L17 13.3165V0.608402C17 0.608402 17 0.608398 17 0.608398ZM17 0.608398V26.0245C15.3312 26.0245 13.6787 25.6958 12.1369 25.0572C10.5951 24.4186 9.19414 23.4825 8.01408 22.3024C6.83403 21.1224 5.89796 19.7215 5.25932 18.1796C4.62068 16.6378 4.29197 14.9853 4.29197 13.3165C4.29197 11.6476 4.62068 9.99512 5.25932 8.45331C5.89796 6.91149 6.83403 5.51056 8.01408 4.33051C9.19413 3.15046 10.5951 2.21439 12.1369 1.57575C13.6787 0.937108 15.3312 0.608401 17 0.608398Z" fill="#90A4C8"/>
                    </svg>
                </div>

                <!--send btn 글자 입력시-->
                <div class="send-btn">
                    <svg class="send-icon" width="23" height="26" viewBox="0 0 23 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1.03659 12.7966C0.741862 12.5018 0.576294 12.102 0.576294 11.6852C0.576294 11.2683 0.741862 10.8685 1.03659 10.5737L10.4693 1.14096C10.7641 0.846232 11.1639 0.680664 11.5808 0.680664C11.9977 0.680664 12.3975 0.846232 12.6923 1.14096L22.125 10.5737C22.4114 10.8702 22.5698 11.2673 22.5662 11.6795C22.5627 12.0917 22.3973 12.486 22.1058 12.7775C21.8143 13.069 21.42 13.2343 21.0078 13.2379C20.5956 13.2415 20.1985 13.083 19.902 12.7966L13.1529 6.04754V24.2621C13.1529 24.679 12.9873 25.0789 12.6924 25.3738C12.3976 25.6686 11.9977 25.8342 11.5808 25.8342C11.1638 25.8342 10.764 25.6686 10.4691 25.3738C10.1743 25.0789 10.0087 24.679 10.0087 24.2621V6.04754L3.25956 12.7966C2.96475 13.0914 2.56495 13.2569 2.14808 13.2569C1.73121 13.2569 1.3314 13.0914 1.03659 12.7966Z" fill="#617DAE"/>
                    </svg>
                </div>         
            </div>
        </div>

        <div class="help-btn">?</div>

        <div class="footer">
            <div class="company-info">(주)창플 | 283-88-00641 | 한범구 | 서울 송파구 송파대로 167 (문정동)테라타워 B동, 707호 | 02-2054-3956 | tiger9@changple.com</div>
            <div class="copyright">@Copyright @ ChangpleTeamBusiness Inc. All Rights Reserved.</div>
            <div class="privacy-policy">개인정보처리방침</div>
        </div>
    </div>
    {% load static %}
    <script src="{% static 'js/index.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 대화 기록을 저장할 배열 추가
            let chatHistory = [];
            
            // Initialize query count from server data
            let remainingQueries = {{ remaining_queries|default:0 }};
            let queryLimit = {{ query_limit|default:10 }};
            let isPremium = {{ is_premium|default:"false" }};
            
            // Get the initial message from Django context
            const initialMessage = "{{ initial_message|escapejs }}";
            
            if (initialMessage) {
                // Process the initial message if available
                callChatAPI(initialMessage);
            }
            
            // 입력 필드와 전송 버튼 가져오기
            const inputBox = document.querySelector('.input-box-unlocked');
            const sendBtn = document.querySelector('.send-btn');
            const changpleBtn = document.querySelector('.changple-btn');
            
            // Show/hide the appropriate button based on input content
            inputBox.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    changpleBtn.style.display = 'none';
                    sendBtn.style.display = 'flex';
                } else {
                    changpleBtn.style.display = 'flex';
                    sendBtn.style.display = 'none';
                }
            });
            
            // Trigger input event to set initial state
            inputBox.dispatchEvent(new Event('input'));
            
            // 전송 버튼 클릭 이벤트
            sendBtn.addEventListener('click', function() {
                const message = inputBox.value.trim();
                if (message) {
                    callChatAPI(message);
                    inputBox.value = ''; // 입력 필드 비우기
                    inputBox.dispatchEvent(new Event('input')); // Update button display
                }
            });
            
            // 엔터키 이벤트
            inputBox.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    const message = this.value.trim();
                    if (message) {
                        callChatAPI(message);
                        this.value = ''; // 입력 필드 비우기
                        this.dispatchEvent(new Event('input')); // Update button display
                    }
                }
            });
            
            // Chat API 호출 함수
            function callChatAPI(query) {
                // Add user message to chat
                addMessageToChat('user', query);
                
                // 로딩 메시지 추가
                const loadingId = addLoadingMessage();
                
                fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // CSRF 토큰 가져오기
                    },
                    body: JSON.stringify({
                        query: query,
                        session_nonce: "{{ chat_session.session_nonce }}",
                        history: chatHistory // 대화 기록 전송
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 로딩 메시지 제거
                    removeLoadingMessage(loadingId);
                    
                    // Check for errors first
                    if (data.error) {
                        addMessageToChat('assistant', `오류가 발생했습니다: ${data.error}`);
                        
                        // Update query count from server data if available
                        if (data.remaining_queries !== undefined) {
                            remainingQueries = data.remaining_queries;
                            queryLimit = data.query_limit || queryLimit;
                            isPremium = data.is_premium || isPremium;
                        }
                        
                        addFreeUseCount(remainingQueries, queryLimit);
                        return;
                    }
                    
                    // API 응답 처리
                    if (data.response) {
                        // 응답을 대화 영역에 추가
                        addMessageToChat('assistant', data.response);
                        
                        // 대화 기록 업데이트 - Format to match what chain.py expects
                        if (chatHistory.length === 0) {
                            // First message - create initial entry
                            chatHistory.push({
                                "human": query,
                                "ai": data.response
                            });
                        } else {
                            // Follow-up - ensure correct format for rephrasing
                            chatHistory.push({
                                "human": query,
                                "ai": data.response
                            });
                        }
                        
                        // If server sent back history, use that instead
                        if (data.history && data.history.length > 0) {
                            chatHistory = data.history;
                        }
                        
                        // 검색 결과로 카드 업데이트
                        if (data.search_results && data.search_results.length > 0) {
                            console.log("Received search results:", data.search_results);
                            updateSearchCards(data.search_results);
                        }
                            
                        // Update query count from server data
                        if (data.remaining_queries !== undefined) {
                            remainingQueries = data.remaining_queries;
                            queryLimit = data.query_limit || queryLimit;
                            isPremium = data.is_premium || isPremium;
                        }
                        
                        // Display updated count
                        addFreeUseCount(remainingQueries, queryLimit);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 로딩 메시지 제거
                    removeLoadingMessage(loadingId);
                    // 오류 메시지 추가
                    addMessageToChat('assistant', '오류가 발생했습니다. 다시 시도해주세요.');
                    addFreeUseCount(remainingQueries, queryLimit);
                });
            }
            
            // 무료 사용 카운트 추가 함수
            function addFreeUseCount(remainingCount, totalLimit) {
                // Use function parameters or default to global variables
                const count = remainingCount !== undefined ? remainingCount : remainingQueries;
                const limit = totalLimit !== undefined ? totalLimit : queryLimit;
                
                const promptContainer = document.querySelector('.prompt-wrapper');
                
                // 고유 ID 생성
                const counterId = 'free-use-count-' + Date.now();
                // Create unique ID for consultation button
                const buttonId = 'open-consultation-modal-' + Date.now();
                
                let displayText = `무료 사용(${count}/${limit})`;
                if (isPremium) {
                    displayText = "프리미엄 이용자";
                }
                
                const freeUseCountHTML = `
                    <div id="${counterId}" class="free-use-count-container">
                        <div class="free-use-count">
                            <p>${displayText}</p>
                        </div>
                        <div class="consultation-request-button">
                            <button id="${buttonId}" class="consultation-btn">1:1 상담 신청</button>
                        </div>
                    </div>
                `;
                
                promptContainer.insertAdjacentHTML('beforeend', freeUseCountHTML);
                
                // Add event listener to the specific button using the unique ID
                document.getElementById(buttonId).addEventListener('click', function() {
                    openConsultationModal();
                });
            }

            
            // 대화 메시지를 화면에 추가하는 함수
            function addMessageToChat(role, content) {
                const promptContainer = document.querySelector('.prompt-wrapper');
                
                if (role === 'user') {
                    // 고유 ID 생성
                    const messageId = 'user-message-' + Date.now();
                    
                    // 사용자 메시지 추가
                    const userMessageHTML = `
                        <div id="${messageId}" class="prompt-answer-block">
                            <div class="prompt-text-area">
                                <p>${content}</p>
                            </div>
                        </div>
                    `;
                    promptContainer.insertAdjacentHTML('beforeend', userMessageHTML);
                    
                    // 새 메시지로 스크롤 (smoothly)
                    document.getElementById(messageId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (role === 'assistant') {
                    // 챗봇 응답에 고유 ID 부여
                    const botMessageId = 'bot-message-' + Date.now();
                    
                    // 마크다운 렌더링 적용
                    const renderedContent = DOMPurify.sanitize(marked.parse(content));
                    
                    const botMessageHTML = `
                        <br>
                        <br>
                        <div id="${botMessageId}" class="prompt-p">${renderedContent}</div>
                    `;
                    promptContainer.insertAdjacentHTML('beforeend', botMessageHTML);
                    
                    // 새 메시지로 스크롤
                    document.getElementById(botMessageId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
            
            // 로딩 메시지 추가
            function addLoadingMessage() {
                const loadingId = 'loading-' + Date.now();
                const promptContainer = document.querySelector('.prompt-wrapper');
                const loadingHTML = `
                    <div id="${loadingId}" class="prompt-p">생성중...</div>
                `;
                promptContainer.insertAdjacentHTML('beforeend', loadingHTML);

                // 새 메시지로 스크롤 (smoothly)
                document.getElementById(loadingId).scrollIntoView({ behavior: 'smooth', block: 'center' });
                return loadingId;
            }
            
            // 로딩 메시지 제거
            function removeLoadingMessage(loadingId) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
            
            // 검색 결과 카드 업데이트
            function updateSearchCards(searchResults) {
                if (searchResults && searchResults.length > 0) {
                    // 새로운 검색 결과 컨테이너 생성
                    const promptContainer = document.querySelector('.prompt-wrapper');
                    
                    // 새 검색 결과 컨테이너 생성
                    const newLinksContainer = document.createElement('div');
                    newLinksContainer.className = 'prompt-links-container';
                    
                    // 최대 3개까지만 표시
                    const maxCardsToShow = Math.min(searchResults.length, 3);
                    
                    for (let i = 0; i < maxCardsToShow; i++) {
                        const result = searchResults[i];
                        const title = result.metadata && result.metadata.title || '제목 없음';
                        // 타이틀 25자로 제한
                        const shortTitle = title.length > 25
                            ? title.substring(0, 25) + '...' 
                            : title;
                        const content = result.content || '';
                        
                        // content 첫 15자만 표시 (있을 경우)
                        const shortContent = content.length > 15 
                            ? content.substring(0, 15) + '...' 
                            : content;
                        
                        const url = result.metadata && result.metadata.url || 'https://cafe.naver.com';
                        
                        // 카드 요소 생성
                        const cardHTML = `
                            <div class="prompt-links-cards">
                                <a href="${url}" target="_blank" class="link-card">
                                    <div class="card-content">
                                        <div class="card-title">${shortTitle}</div>
                                        <div class="card-description">${shortContent}</div>
                                    </div>
                                </a>
                            </div>
                        `;
                        
                        // 새 컨테이너에 카드 추가
                        newLinksContainer.innerHTML += cardHTML;
                    }
                    
                    // 각 대화 후 새 컨테이너를 추가
                    promptContainer.appendChild(newLinksContainer);
                }
            }
            
            // CSRF 토큰 가져오기 위한 함수
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Call addFreeUseCount initially to show the counter when page loads
            addFreeUseCount(remainingQueries, queryLimit);
            
            // 상담 신청 모달 열기 함수
            function openConsultationModal() {
                console.log("Opening consultation modal"); // Debug log
                
                // 모달이 이미 있는지 확인
                if (document.getElementById('consultation-modal')) {
                    console.log("Modal already exists, showing it");
                    document.getElementById('consultation-modal').style.display = 'block';
                    return;
                }
                
                console.log("Creating new modal");
                
                // 모달 HTML 생성
                const modalHTML = `
                    <div id="consultation-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>1:1 상담 신청</h2>
                            <p>상담 요청을 위해 이메일 주소를 입력해주세요.</p>
                            <form id="consultation-form">
                                <div class="form-group">
                                    <label for="user-email">이메일 주소</label>
                                    <input type="email" id="user-email" name="user-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="additional-message">추가 메시지 (선택사항)</label>
                                    <textarea id="additional-message" name="additional-message" rows="4"></textarea>
                                </div>
                                <button type="submit" class="submit-btn">상담 신청하기</button>
                            </form>
                        </div>
                    </div>
                `;
                
                // 모달을 body에 추가
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 닫기 버튼 이벤트 리스너
                document.querySelector('.close').addEventListener('click', function() {
                    document.getElementById('consultation-modal').style.display = 'none';
                });
                
                // 모달 외부 클릭시 닫기
                window.addEventListener('click', function(event) {
                    if (event.target == document.getElementById('consultation-modal')) {
                        document.getElementById('consultation-modal').style.display = 'none';
                    }
                });
                
                // 폼 제출 이벤트 리스너
                document.getElementById('consultation-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    sendConsultationRequest();
                });
            }
            
            // 상담 신청 요청 보내기
            function sendConsultationRequest() {
                console.log("Sending consultation request");
                const userEmail = document.getElementById('user-email').value;
                const additionalMessage = document.getElementById('additional-message').value;
                console.log("Email:", userEmail);
                
                // 모달 내용을 로딩 상태로 변경
                const modalContent = document.querySelector('.modal-content');
                const originalContent = modalContent.innerHTML;
                modalContent.innerHTML = '<div style="text-align: center; padding: 20px;"><p>상담 요청을 전송 중입니다...</p></div>';
                
                const requestData = {
                    user_email: userEmail,
                    session_nonce: "{{ chat_session.session_nonce }}",
                    message: additionalMessage
                };
                console.log("Request data:", requestData);
                
                // API 요청 보내기
                fetch('/notifications/api/consultation-request/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log("Response status:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("Response data:", data);
                    // 성공 또는 오류 메시지 표시
                    if (data.status === 'success') {
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <h3>상담 요청이 성공적으로 전송되었습니다</h3>
                                <p>이메일 주소로 답변을 보내드리겠습니다: ${userEmail}</p>
                                <button id="close-success-modal" class="submit-btn">닫기</button>
                            </div>
                        `;
                        document.getElementById('close-success-modal').addEventListener('click', function() {
                            document.getElementById('consultation-modal').style.display = 'none';
                        });
                    } else {
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <h3>오류가 발생했습니다</h3>
                                <p>${data.error || '상담 요청을 처리하는 중 오류가 발생했습니다.'}</p>
                                <button id="try-again-btn" class="submit-btn">다시 시도하기</button>
                            </div>
                        `;
                        document.getElementById('try-again-btn').addEventListener('click', function() {
                            modalContent.innerHTML = originalContent;
                            // 이벤트 리스너 다시 추가
                            document.querySelector('.close').addEventListener('click', function() {
                                document.getElementById('consultation-modal').style.display = 'none';
                            });
                            document.getElementById('consultation-form').addEventListener('submit', function(e) {
                                e.preventDefault();
                                sendConsultationRequest();
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h3>오류가 발생했습니다</h3>
                            <p>상담 요청을 처리하는 중 오류가 발생했습니다.</p>
                            <button id="try-again-btn" class="submit-btn">다시 시도하기</button>
                        </div>
                    `;
                    document.getElementById('try-again-btn').addEventListener('click', function() {
                        modalContent.innerHTML = originalContent;
                        // 이벤트 리스너 다시 추가
                        document.querySelector('.close').addEventListener('click', function() {
                            document.getElementById('consultation-modal').style.display = 'none';
                        });
                        document.getElementById('consultation-form').addEventListener('submit', function(e) {
                            e.preventDefault();
                            sendConsultationRequest();
                        });
                    });
                });
            }
        });
    </script>
</body>
</html>